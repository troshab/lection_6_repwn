# Stage 02: checksec - –ê–Ω–∞–ª—ñ–∑ –∑–∞—Ö–∏—Å—Ç—ñ–≤ –±—ñ–Ω–∞—Ä–Ω–∏–∫—ñ–≤

## üéØ –ú–µ—Ç–∞ –∑–∞–≤–¥–∞–Ω–Ω—è

–ù–∞–≤—á–∏—Ç–∏—Å—è **—Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞—Ç–∏** —Ç–∞ **—Ä–æ–∑—É–º—ñ—Ç–∏** –∑–∞—Ö–∏—Å–Ω—ñ –º–µ—Ö–∞–Ω—ñ–∑–º–∏ —É –±—ñ–Ω–∞—Ä–Ω–∏—Ö —Ñ–∞–π–ª–∞—Ö. –¶–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –≤–∞–∂–ª–∏–≤–æ –¥–ª—è –≤–∏–±–æ—Ä—É –ø—Ä–∞–≤–∏–ª—å–Ω–æ—ó —Å—Ç—Ä–∞—Ç–µ–≥—ñ—ó –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó.

## üìö –©–æ –≤–∏ –¥—ñ–∑–Ω–∞—î—Ç–µ—Å—å

- –©–æ —Ç–∞–∫–µ Canary (Stack Protector) —ñ —è–∫ –≤—ñ–Ω –ø—Ä–∞—Ü—é—î
- –©–æ —Ç–∞–∫–µ NX (No eXecute) —ñ —á–æ–º—É –≤—ñ–Ω –±–ª–æ–∫—É—î shellcode
- –©–æ —Ç–∞–∫–µ PIE (Position Independent Executable) —ñ ASLR
- –©–æ —Ç–∞–∫–µ RELRO (Relocation Read-Only) —ñ –∑–∞—Ö–∏—Å—Ç GOT
- –Ø–∫ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç `checksec`
- –Ø–∫ –∑–∞—Ö–∏—Å—Ç–∏ –≤–ø–ª–∏–≤–∞—é—Ç—å –Ω–∞ –≤–∏–±—ñ—Ä —Ç–µ—Ö–Ω—ñ–∫–∏ –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó

## üîß –ù–µ–æ–±—Ö—ñ–¥–Ω—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏

```bash
# –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å checksec
sudo apt install checksec

# –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ - —Å–∫–∞—á–∞—Ç–∏ —Å–∫—Ä–∏–ø—Ç
wget https://github.com/slimm609/checksec.sh/raw/master/checksec
chmod +x checksec
sudo mv checksec /usr/local/bin/
```

## üìñ –¢–µ–æ—Ä–µ—Ç–∏—á–Ω–∞ –æ—Å–Ω–æ–≤–∞

### 1. Stack Canary (Stack Protector)

**–©–æ —Ü–µ?** "–ö–∞–Ω–∞—Ä–µ–π–∫–∞" - —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è –º—ñ–∂ –ª–æ–∫–∞–ª—å–Ω–∏–º–∏ –∑–º—ñ–Ω–Ω–∏–º–∏ —Ç–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–º RIP.

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  –í–∏—â–∞ –∞–¥—Ä–µ—Å–∞
‚îÇ   Saved RIP    ‚îÇ  ‚Üê –ö—É–¥–∏ –ø–æ–≤–µ—Ä–Ω–µ—Ç—å—Å—è —Ñ—É–Ω–∫—Ü—ñ—è
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   Saved RBP    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   ** CANARY ** ‚îÇ  ‚Üê –°–µ–∫—Ä–µ—Ç–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è!
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   Local vars   ‚îÇ  ‚Üê –í–∞—à—ñ –¥–∞–Ω—ñ
‚îÇ   char buf[64] ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  –ù–∏–∂—á–∞ –∞–¥—Ä–µ—Å–∞
```

**–Ø–∫ –ø—Ä–∞—Ü—é—î?**

1. **–ü—Ä–∏ –≤—Ö–æ–¥—ñ –≤ —Ñ—É–Ω–∫—Ü—ñ—é**: canary –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –∑—ñ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ–≥–æ —Ä–µ–≥—ñ—Å—Ç—Ä—É `fs:0x28`
2. **–ü—Ä–∏ –≤–∏—Ö–æ–¥—ñ –∑ —Ñ—É–Ω–∫—Ü—ñ—ó**: –ø–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è —á–∏ canary –Ω–µ –∑–º—ñ–Ω–∏–ª–∞—Å—å
3. **–Ø–∫—â–æ –∑–º—ñ–Ω–∏–ª–∞—Å—å**: –ø—Ä–æ–≥—Ä–∞–º–∞ –∞–≤–∞—Ä—ñ–π–Ω–æ –∑–∞–≤–µ—Ä—à—É—î—Ç—å—Å—è –∑ `*** stack smashing detected ***`

**–ü—Ä–∏–∫–ª–∞–¥ –∫–æ–¥—É –∑ canary:**

```c
void vulnerable() {
    char buf[64];
    // Canary –¥–æ–¥–∞–Ω–∞ –∫–æ–º–ø—ñ–ª—è—Ç–æ—Ä–æ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ!
    gets(buf);  // BOF
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ canary –ø–µ—Ä–µ–¥ return
}
```

**–°–∫–æ–º–ø—ñ–ª—å–æ–≤–∞–Ω–æ –∑ `-fstack-protector-all`:**

```asm
vulnerable:
    ; –ó–±–µ—Ä–µ–≥—Ç–∏ canary –∑—ñ fs:0x28
    mov    rax, QWORD PTR fs:0x28
    mov    QWORD PTR [rbp-0x8], rax

    ; –í–∞—à –∫–æ–¥ —Ç—É—Ç...

    ; –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è–º
    mov    rax, QWORD PTR [rbp-0x8]
    xor    rax, QWORD PTR fs:0x28
    je     .L_ok            ; –Ø–∫—â–æ —Ä—ñ–≤–Ω—ñ - –û–ö
    call   __stack_chk_fail ; –Ü–Ω–∞–∫—à–µ - PANIC!
.L_ok:
    ret
```

**–Ø–∫ –µ–∫—Å–ø–ª—É–∞—Ç—É–≤–∞—Ç–∏ –∑ canary?**

- ‚ùå –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏ RIP –Ω–µ –≤–∏–π–¥–µ
- ‚úÖ –ü–æ—Ç—Ä—ñ–±–µ–Ω **leak canary** (–≤–∏—Ç—ñ–∫ –∑–Ω–∞—á–µ–Ω–Ω—è)
- ‚úÖ –ê–±–æ –∑–Ω–∞–π—Ç–∏ **—ñ–Ω—à–∏–π –±–∞–≥** (–Ω–µ BOF)

### 2. NX (No eXecute / DEP)

**–©–æ —Ü–µ?** –ó–∞–±–æ—Ä–æ–Ω–∞ **–≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–¥—É** –≤ –ø–µ–≤–Ω–∏—Ö –æ–±–ª–∞—Å—Ç—è—Ö –ø–∞–º'—è—Ç—ñ (—Å—Ç–µ–∫, heap).

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Code (.text)   ‚îÇ  ‚úÖ –í–∏–∫–æ–Ω—É–≤–∞–Ω–∏–π, ‚ùå –ù–µ –∑–∞–ø–∏—Å—É–≤–∞–Ω–∏–π
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   Data (.data)   ‚îÇ  ‚ùå –ù–µ –≤–∏–∫–æ–Ω—É–≤–∞–Ω–∏–π, ‚úÖ –ó–∞–ø–∏—Å—É–≤–∞–Ω–∏–π
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   Stack          ‚îÇ  ‚ùå –ù–µ –≤–∏–∫–æ–Ω—É–≤–∞–Ω–∏–π (NX ON)
‚îÇ                  ‚îÇ  ‚úÖ –í–∏–∫–æ–Ω—É–≤–∞–Ω–∏–π (NX OFF)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–Ø–∫ –ø—Ä–∞—Ü—é—î NX?**

–ù–∞ —Ä—ñ–≤–Ω—ñ –ø—Ä–æ—Ü–µ—Å–æ—Ä–∞ –∫–æ–∂–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –ø–∞–º'—è—Ç—ñ –º–∞—î –±—ñ—Ç **NX** (–∞–±–æ **XD** —É Intel):
- –Ø–∫—â–æ `NX=1` ‚Üí –ø—Ä–æ—Ü–µ—Å–æ—Ä **–∑–∞–±–æ—Ä–æ–Ω–∏—Ç—å** –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–¥—É –∑ —Ü—ñ—î—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏
- –°–ø—Ä–æ–±–∞ –≤–∏–∫–æ–Ω–∞—Ç–∏ ‚Üí `Segmentation fault`

**–£ Linux —Ü–µ –Ω–∞–∑–∏–≤–∞—î—Ç—å—Å—è:**
- **NX bit** (No eXecute)
- **W^X** (Write XOR Execute) - –∞–±–æ –∑–∞–ø–∏—Å—É–≤–∞–Ω–∏–π, –∞–±–æ –≤–∏–∫–æ–Ω—É–≤–∞–Ω–∏–π

**–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–µ—Ä–µ–∑ readelf:**

```bash
readelf -l binary | grep GNU_STACK
# GNU_STACK  0x000000 0x0000 0x0000 0x00000 0x00000 RW  0x10  ‚Üê NX ON (Read-Write)
# GNU_STACK  0x000000 0x0000 0x0000 0x00000 0x00000 RWE 0x10  ‚Üê NX OFF (Read-Write-Execute)
```

**–í–ø–ª–∏–≤ –Ω–∞ –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—é:**

- **NX OFF**: –º–æ–∂–Ω–∞ –∑–∞–∫–∏–Ω—É—Ç–∏ shellcode –≤ —Å—Ç–µ–∫ —ñ –≤–∏–∫–æ–Ω–∞—Ç–∏
  ```
  payload = shellcode + padding + p64(address_of_shellcode)
  ```

- **NX ON**: shellcode –≤ —Å—Ç–µ–∫—É –Ω–µ –≤–∏–∫–æ–Ω–∞—î—Ç—å—Å—è, –ø–æ—Ç—Ä—ñ–±–µ–Ω **ROP** (Return Oriented Programming)
  ```
  payload = padding + rop_chain
  ```

### 3. PIE (Position Independent Executable) + ASLR

**PIE** - –±—ñ–Ω–∞—Ä–Ω–∏–∫ –º–æ–∂–µ –±—É—Ç–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π –∑–∞ **–±—É–¥—å-—è–∫–æ—é –∞–¥—Ä–µ—Å–æ—é**.
**ASLR** - —è–¥—Ä–æ Linux **—Ä–∞–Ω–¥–æ–º—ñ–∑—É—î** –∞–¥—Ä–µ—Å–∏ –ø—Ä–∏ –∫–æ–∂–Ω–æ–º—É –∑–∞–ø—É—Å–∫—É.

```
–ë–µ–∑ PIE (–∑–∞–≤–∂–¥–∏ 0x400000):
./binary    ‚Üí  0x400000 (–±–∞–∑–æ–≤–∞ –∞–¥—Ä–µ—Å–∞)
./binary    ‚Üí  0x400000 (—Ç–∞ —Å–∞–º–∞!)
./binary    ‚Üí  0x400000 (—Ç–∞ —Å–∞–º–∞!)

–ó PIE + ASLR (–≤–∏–ø–∞–¥–∫–æ–≤—ñ –∞–¥—Ä–µ—Å–∏):
./binary    ‚Üí  0x5555555 54000
./binary    ‚Üí  0x5555557 8a000
./binary    ‚Üí  0x5555559 2f000
```

**–ï—Ñ–µ–∫—Ç –Ω–∞ –∞–¥—Ä–µ—Å–∏ —Ñ—É–Ω–∫—Ü—ñ–π:**

```bash
# PIE OFF - –∞–¥—Ä–µ—Å–∏ —Å—Ç–∞–±—ñ–ª—å–Ω—ñ
objdump -d binary | grep '<win>'
0000000000401136 <win>:   # –ó–∞–≤–∂–¥–∏ 0x401136

# PIE ON - –∞–¥—Ä–µ—Å–∏ –≤—ñ–¥–Ω–æ—Å–Ω—ñ
objdump -d binary | grep '<win>'
0000000000001136 <win>:   # –ë–∞–∑–æ–≤–∞ –∞–¥—Ä–µ—Å–∞ + 0x1136
```

**–Ø–∫ –µ–∫—Å–ø–ª—É–∞—Ç—É–≤–∞—Ç–∏ –∑ PIE?**

- ‚ùå Hardcode –∞–¥—Ä–µ—Å–∏ –Ω–µ –ø—Ä–∞—Ü—é—î
- ‚úÖ –ü–æ—Ç—Ä—ñ–±–µ–Ω **leak –∞–¥—Ä–µ—Å–∏** –∑ –ø—Ä–æ—Ü–µ—Å—É
- ‚úÖ –†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –±–∞–∑–æ–≤—É –∞–¥—Ä–µ—Å—É: `base = leaked_addr - known_offset`

**ASLR –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–º—É —Ä—ñ–≤–Ω—ñ:**

```bash
# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å ASLR
cat /proc/sys/kernel/randomize_va_space
# 0 = OFF (–≤—Å–µ —Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ)
# 1 = Conservative (heap/stack/libraries, –∞–ª–µ –Ω–µ main executable —è–∫—â–æ –Ω–µ PIE)
# 2 = Full (–≤—Å–µ –≤–∫–ª—é—á–Ω–æ –∑ PIE)

# –í–∏–º–∫–Ω—É—Ç–∏ (–¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è, –ø–æ—Ç—Ä—ñ–±–µ–Ω root)
echo 0 | sudo tee /proc/sys/kernel/randomize_va_space

# –£–≤—ñ–º–∫–Ω—É—Ç–∏ –Ω–∞–∑–∞–¥
echo 2 | sudo tee /proc/sys/kernel/randomize_va_space
```

### 4. RELRO (Relocation Read-Only)

**–©–æ —Ü–µ?** –ó–∞—Ö–∏—Å—Ç —Ç–∞–±–ª–∏—Ü—å **GOT** (Global Offset Table) —Ç–∞ **PLT** (Procedure Linkage Table).

**–¢—Ä–∏ —Ä–µ–∂–∏–º–∏:**

**No RELRO:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  GOT/PLT    ‚îÇ  ‚úÖ –ó–∞–ø–∏—Å—É–≤–∞–Ω–∏–π –∑–∞–≤–∂–¥–∏
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```
- –ú–æ–∂–Ω–∞ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏ –∞–¥—Ä–µ—Å–∏ –≤ GOT ‚Üí –≤–∏–∫–ª–∏–∫ –¥–æ–≤—ñ–ª—å–Ω–æ—ó —Ñ—É–Ω–∫—Ü—ñ—ó
- –¢–µ—Ö–Ω—ñ–∫–∞: **GOT overwrite**

**Partial RELRO:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  .got.plt   ‚îÇ  ‚úÖ –ó–∞–ø–∏—Å—É–≤–∞–Ω–∏–π –¥–æ –ø–µ—Ä—à–æ–≥–æ –≤–∏–∫–ª–∏–∫—É
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```
- GOT –∑–∞—Ö–∏—â–µ–Ω–∞, –∞–ª–µ `.got.plt` –≤—Å–µ —â–µ –º–æ–∂–Ω–∞ –∑–º—ñ–Ω–∏—Ç–∏
- Lazy binding –ø—Ä–∞—Ü—é—î
- **–ë—ñ–ª—å—à—ñ—Å—Ç—å –ø—Ä–æ–≥—Ä–∞–º** –º–∞—é—Ç—å Partial RELRO

**Full RELRO:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  GOT/PLT    ‚îÇ  ‚ùå –¢—ñ–ª—å–∫–∏ —á–∏—Ç–∞–Ω–Ω—è (read-only)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```
- **–í—Å—ñ –∞–¥—Ä–µ—Å–∏** —Ä–µ–∑–æ–ª–≤—è—Ç—å—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ (`-z now`)
- GOT —Å—Ç–∞—î read-only ‚Üí **–Ω–µ–º–æ–∂–ª–∏–≤–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏**
- –ü–æ–≤—ñ–ª—å–Ω—ñ—à–∏–π —Å—Ç–∞—Ä—Ç –ø—Ä–æ–≥—Ä–∞–º–∏

**–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞:**

```bash
readelf -l binary | grep GNU_RELRO
# –Ø–∫—â–æ —î ‚Üí Partial –∞–±–æ Full

readelf -d binary | grep BIND_NOW
# –Ø–∫—â–æ —î BIND_NOW ‚Üí Full RELRO
```

## üöÄ –ü–æ–∫—Ä–æ–∫–æ–≤–µ —Ä—ñ—à–µ–Ω–Ω—è

### –ö—Ä–æ–∫ 1: –ó–±—É–¥—É–π—Ç–µ –±—ñ–Ω–∞—Ä–Ω–∏–∫–∏

```bash
cd stage02_checksec
./build.sh
```

–¶–µ —Å—Ç–≤–æ—Ä–∏—Ç—å **4 –≤–∞—Ä—ñ–∞–Ω—Ç–∏** –∑ —Ä—ñ–∑–Ω–∏–º–∏ –∑–∞—Ö–∏—Å—Ç–∞–º–∏:
- `stage02_no_protections` - –≤—Å—ñ OFF
- `stage02_all_protections` - –≤—Å—ñ ON
- `stage02_only_nx` - —Ç—ñ–ª—å–∫–∏ NX
- `stage02_nx_pie` - NX + PIE

### –ö—Ä–æ–∫ 2: –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∑–∞—Ö–∏—Å—Ç–∏

```bash
checksec --file=../build/stage02_no_protections
checksec --file=../build/stage02_all_protections
checksec --file=../build/stage02_only_nx
checksec --file=../build/stage02_nx_pie
```

### –ö—Ä–æ–∫ 3: –ü–æ—Ä—ñ–≤–Ω—è–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏

**–í–∞—Ä—ñ–∞–Ω—Ç 1: –ë–µ–∑ –∑–∞—Ö–∏—Å—Ç—ñ–≤**
```
RELRO           STACK CANARY      NX            PIE
No RELRO        No canary found   NX disabled   No PIE (0x400000)
```

**–í–∞—Ä—ñ–∞–Ω—Ç 2: –í—Å—ñ –∑–∞—Ö–∏—Å—Ç–∏**
```
RELRO           STACK CANARY      NX            PIE
Full RELRO      Canary found      NX enabled    PIE enabled
```

**–í–∞—Ä—ñ–∞–Ω—Ç 3: –¢—ñ–ª—å–∫–∏ NX**
```
RELRO           STACK CANARY      NX            PIE
Partial RELRO   No canary found   NX enabled    No PIE (0x400000)
```

**–í–∞—Ä—ñ–∞–Ω—Ç 4: NX + PIE**
```
RELRO           STACK CANARY      NX            PIE
Partial RELRO   No canary found   NX enabled    PIE enabled
```

## üîç –î–µ—Ç–∞–ª—å–Ω–∏–π –∞–Ω–∞–ª—ñ–∑

### –†—É—á–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –±–µ–∑ checksec

#### 1. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ Canary

```bash
objdump -d binary | grep -A20 '<main>' | grep fs:0x28
# –Ø–∫—â–æ –∑–Ω–∞–π–¥–µ–Ω–æ fs:0x28 ‚Üí Canary ON
```

#### 2. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ NX

```bash
readelf -l binary | grep GNU_STACK
# RW  ‚Üí NX ON
# RWE ‚Üí NX OFF
```

#### 3. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ PIE

```bash
readelf -h binary | grep Type
# EXEC (Executable file) ‚Üí PIE OFF
# DYN (Shared object file) ‚Üí PIE ON (–∞–±–æ –ø—Ä–æ—Å—Ç–æ .so)

file binary
# ELF 64-bit LSB executable ‚Üí PIE OFF
# ELF 64-bit LSB pie executable ‚Üí PIE ON
```

#### 4. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ RELRO

```bash
readelf -l binary | grep GNU_RELRO
# –ù–µ–º–∞—î ‚Üí No RELRO
# –Ñ ‚Üí Partial –∞–±–æ Full

readelf -d binary | grep BIND_NOW
# –Ñ ‚Üí Full RELRO
# –ù–µ–º–∞—î ‚Üí Partial RELRO
```

## üí° –°—Ç—Ä–∞—Ç–µ–≥—ñ—ó –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó

### –ú–∞—Ç—Ä–∏—Ü—è: –ó–∞—Ö–∏—Å—Ç–∏ ‚Üí –¢–µ—Ö–Ω—ñ–∫–∞

| Canary | NX | PIE | RELRO | –¢–µ—Ö–Ω—ñ–∫–∞ –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó |
|--------|----|----|-------|---------------------|
| OFF | OFF | OFF | OFF | Shellcode –≤ —Å—Ç–µ–∫—É + ret –¥–æ –Ω—å–æ–≥–æ |
| OFF | ON | OFF | OFF | ROP chain (ret2libc) |
| OFF | ON | OFF | Partial | ROP + –º–æ–∂–ª–∏–≤–∏–π GOT overwrite |
| OFF | ON | ON | Partial | Leak PIE ‚Üí ROP chain |
| OFF | ON | ON | Full | Leak PIE ‚Üí ROP chain (–±–µ–∑ GOT overwrite) |
| ON | - | - | - | –ü–æ—Ç—Ä—ñ–±–µ–Ω leak canary + –≤–∏—â–µ |

### –ü—Ä–∏–∫–ª–∞–¥–∏

**–°—Ü–µ–Ω–∞—Ä—ñ–π 1: –í—Å–µ –≤–∏–º–∫–Ω–µ–Ω–æ (stage06_ret2win)**

```python
# –ü—Ä–æ—Å—Ç—ñ—à–∏–π exploit –Ω–∞ —Å–≤—ñ—Ç—ñ
payload = b'A' * offset + p64(addr_of_win)
```

**–°—Ü–µ–Ω–∞—Ä—ñ–π 2: –¢—ñ–ª—å–∫–∏ NX —É–≤—ñ–º–∫–Ω–µ–Ω–∏–π**

```python
# –ù–µ –º–æ–∂–Ω–∞ shellcode, –∞–ª–µ –º–æ–∂–Ω–∞ ret2libc
payload = b'A' * offset + rop_chain
```

**–°—Ü–µ–Ω–∞—Ä—ñ–π 3: NX + PIE**

```python
# 1. Leak –∞–¥—Ä–µ—Å–∏
io.recvuntil(b'Address: ')
leaked = int(io.recvline(), 16)
base = leaked - known_offset

# 2. –†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –∞–¥—Ä–µ—Å–∏
win_addr = base + 0x1234

# 3. –ï–∫—Å–ø–ª–æ–π—Ç
payload = b'A' * offset + p64(win_addr)
```

**–°—Ü–µ–Ω–∞—Ä—ñ–π 4: –í—Å—ñ –∑–∞—Ö–∏—Å—Ç–∏ (—Ä–µ–∞–ª—å–Ω—ñ –ø—Ä–æ–≥—Ä–∞–º–∏)**

```python
# 1. Leak canary
# 2. Leak PIE base
# 3. Leak libc base
# 4. ROP chain –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º Full RELRO
```

## üéì –ü—Ä–∞–∫—Ç–∏—á–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è

### –ó–∞–≤–¥–∞–Ω–Ω—è 1: –ó–±–µ—Ä—ñ—Ç—å –≤–ª–∞—Å–Ω–∏–π –±—ñ–Ω–∞—Ä–Ω–∏–∫

```bash
cat > test.c <<EOF
#include <stdio.h>
int main() {
    char buf[64];
    gets(buf);
    return 0;
}
EOF

# –ë–µ–∑ –∑–∞—Ö–∏—Å—Ç—ñ–≤
gcc -fno-stack-protector -z execstack -no-pie test.c -o test_noprotect

# –í—Å—ñ –∑–∞—Ö–∏—Å—Ç–∏
gcc -fstack-protector-all -pie -fPIE -z now -z relro test.c -o test_fullprotect

# –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ
checksec --file=test_noprotect
checksec --file=test_fullprotect
```

### –ó–∞–≤–¥–∞–Ω–Ω—è 2: –ï–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –∑ canary

```bash
# –ó–±–µ—Ä—ñ—Ç—å –∑ canary
gcc -fstack-protector-all test.c -o test_canary

# –°–ø—Ä–æ–±—É–π—Ç–µ BOF
echo "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" | ./test_canary
# –†–µ–∑—É–ª—å—Ç–∞—Ç: *** stack smashing detected ***
```

### –ó–∞–≤–¥–∞–Ω–Ω—è 3: ASLR –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç

```bash
cat > aslr_test.c <<EOF
#include <stdio.h>
int main() {
    printf("main() at: %p\n", main);
    return 0;
}
EOF

gcc -pie -fPIE aslr_test.c -o aslr_test

# –ó–∞–ø—É—Å—Ç—ñ—Ç—å 5 —Ä–∞–∑—ñ–≤
for i in {1..5}; do ./aslr_test; done
# –ê–¥—Ä–µ—Å–∏ —Ä—ñ–∑–Ω—ñ –∫–æ–∂–µ–Ω —Ä–∞–∑!
```

### –ó–∞–≤–¥–∞–Ω–Ω—è 4: –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è —Ä–æ–∑–º—ñ—Ä—ñ–≤

```bash
# Full RELRO –∑–±—ñ–ª—å—à—É—î —Ä–æ–∑–º—ñ—Ä
gcc test.c -o test_partial -z relro
gcc test.c -o test_full -z now -z relro

ls -lh test_partial test_full
# test_full –±—É–¥–µ —Ç—Ä–æ—Ö–∏ –±—ñ–ª—å—à–∏–π
```

## üîó –¢–∞–±–ª–∏—Ü—è –ø—Ä–∞–ø–æ—Ä—ñ–≤ –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó

| –ó–∞—Ö–∏—Å—Ç | –£–≤—ñ–º–∫–Ω—É—Ç–∏ | –í–∏–º–∫–Ω—É—Ç–∏ |
|--------|-----------|----------|
| Canary | `-fstack-protector-all` | `-fno-stack-protector` |
| NX | (default) | `-z execstack` |
| PIE | `-pie -fPIE` | `-no-pie` |
| RELRO Partial | `-z relro` | `-z norelro` |
| RELRO Full | `-z now -z relro` | `-z norelro` |

## üìö –ö–æ—Ä–∏—Å–Ω—ñ –∫–æ–º–∞–Ω–¥–∏

```bash
# –®–≤–∏–¥–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞
checksec --file=binary

# –î–µ—Ç–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ –ø—Ä–æ ELF
readelf -a binary | less

# –î–∏–∑–∞—Å–µ–º–±–ª—é–≤–∞–Ω–Ω—è
objdump -d binary | less

# Strings (—à—É–∫–∞—î–º–æ –ø—ñ–¥–∫–∞–∑–∫–∏)
strings binary

# –§–∞–π–ª–æ–≤–∏–π —Ç–∏–ø
file binary

# Hex dump
xxd binary | less

# strace (—Å–∏—Å—Ç–µ–º–Ω—ñ –≤–∏–∫–ª–∏–∫–∏)
strace ./binary

# ltrace (–±—ñ–±–ª—ñ–æ—Ç–µ—á–Ω—ñ –≤–∏–∫–ª–∏–∫–∏)
ltrace ./binary
```

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –≤–∏–∫–æ–Ω–∞–Ω–Ω—è

- [ ] –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ checksec
- [ ] –ó—ñ–±—Ä–∞–Ω–æ –≤—Å—ñ 4 –≤–∞—Ä—ñ–∞–Ω—Ç–∏ –±—ñ–Ω–∞—Ä–Ω–∏–∫—ñ–≤
- [ ] –ü–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ –∑–∞—Ö–∏—Å—Ç–∏ —á–µ—Ä–µ–∑ checksec
- [ ] –ó—Ä–æ–∑—É–º—ñ–ª–æ —â–æ —Ç–∞–∫–µ Canary —ñ —è–∫ –≤—ñ–Ω –ø—Ä–∞—Ü—é—î
- [ ] –ó—Ä–æ–∑—É–º—ñ–ª–æ —â–æ —Ç–∞–∫–µ NX —ñ —á–æ–º—É –±–ª–æ–∫—É—î shellcode
- [ ] –ó—Ä–æ–∑—É–º—ñ–ª–æ —â–æ —Ç–∞–∫–µ PIE/ASLR —ñ –Ω–∞–≤—ñ—â–æ leak
- [ ] –ó—Ä–æ–∑—É–º—ñ–ª–æ —â–æ —Ç–∞–∫–µ RELRO —ñ –∑–∞—Ö–∏—Å—Ç GOT
- [ ] –ú–æ–∂—É –≤–∏–±—Ä–∞—Ç–∏ —Å—Ç—Ä–∞—Ç–µ–≥—ñ—é –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó –∑–∞ –∑–∞—Ö–∏—Å—Ç–∞–º–∏
- [ ] –ì–æ—Ç–æ–≤–∏–π –¥–æ Stage 03!

---

**–ß–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è:** 15-20 —Ö–≤–∏–ª–∏–Ω
**–°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å:** ‚≠ê‚≠ê‚òÜ‚òÜ‚òÜ (–õ–µ–≥–∫–∞)
**–ö–∞—Ç–µ–≥–æ—Ä—ñ—è:** PWN / Binary Analysis
